<!doctype html><html lang=en-us dir=ltr><head><script src=https://cdn.cookielaw.org/consent/7f944245-c5cd-4eed-a90e-dd955adfdd08/OtAutoBlock.js></script><script src=https://cdn.cookielaw.org/scripttemplates/otSDKStub.js data-domain-script=7f944245-c5cd-4eed-a90e-dd955adfdd08></script><script type=text/javascript>function OptanonWrapper(){}</script><script>const callback=(e)=>{for(const t of e)t.type==="childList"&&t.addedNodes.forEach(e=>{e.nodeName==="IMG"&&document.querySelectorAll('img:not([src^="http"]):not([data-ot-ignore])').forEach(e=>{e.setAttribute("data-ot-ignore","")})})},config={attributes:!0,childList:!0,subtree:!0,attributeFilter:["src"]},observer=new MutationObserver(callback);observer.observe(document.documentElement,config)</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-NJXWQL"),gtag("consent","default",{analytics_storage:"granted",ad_storage:"granted",functionality_storage:"granted",wait_for_update:500}),gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied",functionality_storage:"denied",region:["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE","IS","LI","NO","GB","PE","RU"],wait_for_update:500}),window.geofeed=e=>{dataLayer.push({event:"OneTrustCountryLoad",oneTrustCountryId:e.country.toString()})};const json=document.createElement("script");json.setAttribute("src","https://geolocation.onetrust.com/cookieconsentpub/v1/geo/location/geofeed"),document.head.appendChild(json)</script><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Configure OpenID Connect in AWS to retrieve temporary credentials | GitLab Docs</title><link rel=icon href=/favicon.ico sizes=any><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifests/manifest.webmanifest><meta name=theme-color content="#FC6D26"><link rel=canonical href=https://docs.gitlab.com/ci/cloud_services/aws/><meta name=description content="GitLab product documentation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"GitLab Docs","url":"https://docs.gitlab.com/"}</script><link rel=preload href=/gitlab_ui/fonts/GitLabSans.woff2 type=font/woff2 as=font crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabSans-Italic.woff2 crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabMono.woff2 crossorigin><link rel=stylesheet href=/gitlab_ui/ui/index.css><link rel=stylesheet href=/vite/main.css><link rel=stylesheet href=/css/syntax-dark.min.css id=syntax-dark-theme><link rel=stylesheet href=/css/syntax-light.min.css id=syntax-light-theme><script>(function(){const p="gitlab-docs-theme",g="gitlab-docs-layout",e={LIGHT:"light",DARK:"dark",AUTO:"auto"},i={FIXED:"fixed",FLUID:"fluid"},d="light",f="fixed";let r=!1;const t=localStorage?.getItem(p),m=localStorage?.getItem(g),l=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?e.DARK:e.LIGHT;function h(){return t&&(t===e.LIGHT||t===e.DARK)?t:(t===e.AUTO&&(r=!0),l||d)}function u(){return m===i.FLUID?i.FLUID:f}const s=h(),c=u(),n=document.documentElement;n.classList.remove("gl-dark","gl-light"),n.classList.add(s===e.DARK?"gl-dark":"gl-light"),c===i.FLUID&&(n.classList.add("fluid"),n.classList.remove("fixed"));const a=document.getElementById("syntax-dark-theme"),o=document.getElementById("syntax-light-theme");a&&o&&(s===e.DARK?(a.disabled=!1,o.disabled=!0):(a.disabled=!0,o.disabled=!1)),window.__initialTheme=r?e.AUTO:s,window.__initialLayout=c})()</script><meta name=gitlab_docs_base_url content="/"><meta name=gitlab_docs_page_owner data-stage="Software Supply Chain Security" data-group="Pipeline Security"><meta class=elastic name=gitlab_docs_version content="18.6"><meta class=elastic name=gitlab_docs_section content="use_gitlab"><meta class=elastic name=gitlab_docs_breadcrumbs content="Use GitLab › Use CI/CD to build your application › Pipeline security › Connect to cloud services"><script>window.pageMetadata={trail:[{path:"user/",title:"Use GitLab"},{path:"topics/build_your_application/",title:"Use CI/CD to build your application"},{path:"ci/pipeline_security/",title:"Pipeline security"},{path:"ci/cloud_services/",title:"Connect to cloud services"},{path:"ci/cloud_services/aws/",title:"Configure OpenID Connect in AWS"}]}</script><meta name=gitlab_docs_legacy_path content="/ee/ci/cloud_services/aws/index.html"><meta name=gitlab_docs_hugo_launch_version content="17.9"><script>const ELASTIC_CLOUD_ID="gitlab-docs-website:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDQwZTQyYTQzMTJiZjQyMzNiMzBiZTg0MTU5YjlkNmE1JGMxODg4Y2U5OTY0YzQzZjc5ZjQ1YTk5NDZmMjI0ODg0",ELASTIC_KEY="cDFpLWJaSUJXVHBqWWI4VGZKN3M6eENBSjl4WDRSRnlCUW94ajRQazhLQQ==",ELASTIC_INDEX="search-gitlab-docs-hugo"</script><script type=module src=/vite/elastic_search.js></script><script type=module src=/vite/history.js></script><script>const FS_IDENTIFIER="AIzaSyCLdi3jHHjkmLji9D8uj_RNPMHcdrYoIW4",RECAPTCHA_PUBLIC_KEY="6Le4R3UrAAAAALsIlK_siq0_UhPD-0rD-ImF1gfO"</script><meta name=google-site-verification content="AcGSBNaKDWnLgcYotlVibGy6STm2Y6_KJSaRxrA90xY"><meta name=google-site-verification content="6eFQOFLxYAer08ROqc3I-SAi44F9NmvH7PrUUBR3oCI"><meta name=google-site-verification content="xAUTWp3CDg-tU1LVVwsM9OrVhLR7L3SmiyKzkOuPNos"><meta name=google-site-verification content="F0zzwaMpiyWFcPQ1Lqu18qN3EnuQsqFXbySl_29yvHs"><meta name=google-site-verification content="nwo1bVaU0t9TZxZyM-aOI6-CofaH9GRL-uBPbdREWgc"><meta name=google-site-verification content="rWoHrtHEmIX0t28oOb1ZEDMYZb_EZA6rr6ZOl5otEPI"><meta name=google-site-verification content="fSxr8-uslxcuFL0N-oECp3Tm0RPNEGX97wbdayKOEL8"><meta name=google-site-verification content="ISxyLVnZqU8oY3jwrK7EO9o-2DOTvLJwPse7bZz6yhs"><meta name=google-site-verification content="x1WspIvz3ZHqS0gezfX_P-qiRDOeP2Oyrd68zrU2ErI"><meta name=google-site-verification content="DfXB2Za52GT3zs_vuLIAL4Mi3M3K4qxXcg7MAs0CUqo"><meta name=google-site-verification content="BCEBC2LC7A1NzO9Com1oBrWK88tV_QXfUL0i9mwXPL0"><meta name=google-site-verification content="a2lNcHMorfS43aoISjZt5_BBPo-H1UaTKMQdBgZO9iY"><meta name=google-site-verification content="0s16pP9MelY6wDHRf-izXb5pwLU01IogP-Uc_e8f3GU"><meta name=google-site-verification content="H474RNof35Xp8fLg02fZbg9Dzxdtfch6vtcjzpmUraU"><meta name=google-site-verification content="E0FlhpgBGeE7d1pQ6amdcIWPMDLDeu15-HLQVoDTguE"><meta name=google-site-verification content="opQd7_rXtPy-pX5CO_XZiztzeQEsXnB3j6Y1_dZAizA"><meta name=google-site-verification content="06Kq4AoXdmBOjOAkbPvnYGtSxnn4Q9QBqEO55PLlw5c"><meta name=google-site-verification content="djBBokRFSWV_VRlSE51V5TZSPzMC6hml5l-Sb22WglE"><meta name=google-site-verification content="UOW6nOsvbyMeIySuamzbws4kNC_WqehamWfoxxtKjZ8"><meta name=google-site-verification content="hXU1Gsdba74DUbvbdUHRl9o0cQeiwXIhAdIllOG6p8E"><meta name=google-site-verification content="YFeHIAPk9lE76ubVMeq4P0sQVnzo2-a4k1oU_bPY8yE"><meta name=google-site-verification content="h8ICI4eDkvXmYaGDuLTLoWuXnLn-KUkChqYB-roMRsw"><meta name=google-site-verification content="9QW7feFNlCpMLPm7vAWEU-v14vdzb0Bb3RAk-8e_a18"><meta name=google-site-verification content="26kXLBOjaYRb2UwzWTDl1I1nzA2NxMunhp7SUtxGV6E"><meta name=google-site-verification content="jr3C8t6vKGPyN9GV3esdHY_xGYyQaUNznIl-Un2RObA"><meta name=google-site-verification content="WdlBpRU0ec1ieKqrTY_772OhG23FY45VQ4Lv9DyLJ_Y"><meta name=google-site-verification content="n9i6B9q4Xjr_etK2nQGZH1msoo7vIv9SXV8SQLOUA7c"><meta name=zd-site-verification content="ony3w7hk1vs6tfyrc51mld"><meta name=zd-site-verification content="gtuq65qdzt6n31viazi6hj"></head><body data-elastic-exclude><nav data-ga-section=header data-elastic-exclude><div class="header-wrapper gl-w-full gl-fixed gl-z-4"><div class=header><div class="header-top gl-flex gl-items-center"><a href=#skipTarget class="gl-sr-only skip-link">Skip to main content</a>
<a class=navbar-logo href=/><span class=gl-sr-only>Go to GitLab Docs homepage</span></a><div class="mobile-header gl-w-full gl-text-base"><div class=mobile-header-overlay></div><div class="header-right collapse gl-z-4 gl-border-t lg:gl-border-0"><div class="search-wrapper lg:gl-ml-4 lg:gl-grow"><div class="js-elastic-search-form gl-spinner-container"><span role=status aria-label=Loading class="gl-ml-3 gl-align-text-bottom! gl-spinner gl-spinner gl-spinner-sm"></span></div></div><div class="gl-flex gl-flex-col gl-gap-3 gl-mt-5 lg:gl-mt-0 lg:gl-flex-row lg:gl-items-center gl-ml-auto"><a class="whats-new gl-button btn-default btn-default-tertiary gl-hidden lg:gl-block" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a><div data-vue-app=versions-menu></div><div data-vue-app=appearance-toggle class="gl-hidden lg:gl-block"></div><div class="gl-flex gl-justify-evenly lg:gl-justify-normal gl-items-center gl-gap-5"><a class="whats-new gl-button btn-default btn-default-tertiary gl-w-full lg:gl-hidden hover:gl-no-underline" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a>
<a class="free-trial-btn cta-button gl-button btn-confirm gl-w-full hover:gl-no-underline" href="https://gitlab.com/-/trial_registrations/new?glm_source=docs.gitlab.com&amp;amp;glm_content=navigation-cta-docs" target=_blank rel="noopener noreferrer" role=button>Get free trial</a></div></div></div></div><button class="navbar-toggle gl-button btn-default lg:gl-hidden" data-toggle=collapse data-target=.header-right>
<span class=navbar-toggle-icon></span>
<span class=gl-sr-only>Toggle menu</span></button></div><div class="header-bottom gl-border-t lg:gl-border-b"><ul class="subheader-menu gl-hidden lg:gl-flex gl-list-none gl-text-base gl-space-x-5 gl-py-4 gl-pl-0 gl-mb-0"><li><a href=/user/ class=active>Use GitLab</a></li><li><a href=/user/gitlab_duo/>GitLab Duo</a></li><li><a href=/api/>Extend</a></li><li><a href=/install/>Install</a></li><li><a href=/administration/>Administer</a></li><li><a href=/subscriptions/>Subscribe</a></li><li><a href=/development/>Contribute</a></li><li><a href=/solutions/>Solutions</a></li></ul></div></div></div></nav><main data-ga-section=content-body><div id=js-version-banner></div><div class="template-single gl-flex gl-h-full"><div class=side-nav data-ga-section=side-nav data-vue-app=sidebar-menu></div><div data-pagefind-body class=main-content><div class=docs-content><div class="gl-flex gl-h-5 gl-items-center gl-my-6"><div data-vue-app=open-sidebar></div><div data-vue-app=breadcrumb-nav></div></div><hr class="gl-border-t gl-px-5 lg:gl-hidden"><div class="gl-pt-4 gl-mt-4 lg:gl-pt-0 lg:gl-mt-0 lg:gl-border-t-0"><h1 id=skipTarget class=gl-mb-6>Configure OpenID Connect in AWS to retrieve temporary credentials</h1></div><div data-elastic-include><div class="availability gl-pl-4 gl-mb-5"><ul class="gl-list-none gl-p-0 gl-m-0"><li><span class=gl-font-bold>Tier</span>: Free, Premium, Ultimate</li><li><span class=gl-font-bold>Offering</span>: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li></ul></div><div class="alert alert-type-warning gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p><code>CI_JOB_JWT_V2</code> was <a href=/update/deprecations/#old-versions-of-json-web-tokens-are-deprecated>deprecated in GitLab 15.9</a>
and is scheduled to be removed in GitLab 17.0. Use <a href=/ci/secrets/id_token_authentication/>ID tokens</a> instead.</p></div></div><p>This tutorial shows you how to use a GitLab CI/CD job with a JSON web token (JWT) to retrieve temporary credentials from AWS without storing secrets.
To do this, you must configure OpenID Connect (OIDC) for ID federation between GitLab and AWS. For background and requirements for integrating GitLab using OIDC, see <a href=/ci/cloud_services/>Connect to cloud services</a>.</p><p>To complete this tutorial:</p><ol><li><a href=/ci/cloud_services/aws/#add-the-identity-provider>Add the identity provider</a></li><li><a href=/ci/cloud_services/aws/#configure-a-role-and-trust>Configure the role and trust</a></li><li><a href=/ci/cloud_services/aws/#retrieve-temporary-credentials>Retrieve a temporary credential</a></li></ol><h2 id=add-the-identity-provider>Add the identity provider</h2><p>Create GitLab as a IAM OIDC provider in AWS following these <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html>instructions</a>.</p><p>Include the following information:</p><ul><li><p><strong>Provider URL</strong>: The address of your GitLab instance, such as <code>https://gitlab.com</code> or <code>http://gitlab.example.com</code>.
This address must be publicly accessible. If this is not publicly available, see how to
<a href=/ci/cloud_services/aws/#configure-a-non-public-gitlab-instance>configure a non-public GitLab instance</a></p></li><li><p><strong>Audience</strong>: The logical name of the target service you intend to use the requested security token with.</p><ul><li>In AWS OIDC integrations, this typically matches the audience value configured in your IAM OIDC identity provider (often <code>sts.amazonaws.com</code> or your GitLab instance URL).</li><li>This value is validated by AWS to ensure the token was intended for your specific identity provider.</li></ul><div class="alert alert-type-note gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>Using <code>https://gitlab.com</code> or your GitLab instance URL might work if the AWS identity provider reference matches it, but this is semantically misleading.
The audience should represent the service that validates and accepts the token.</p></div></div></li></ul><h2 id=configure-a-role-and-trust>Configure a role and trust</h2><p>After you create the identity provider, configure a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html>web identity role</a> with conditions for limiting access to GitLab resources. Temporary credentials are obtained using <a href=https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html>AWS Security Token Service</a>, so set the <code>Action</code> to <a href=https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html><code>sts:AssumeRoleWithWebIdentity</code></a>.</p><p>You can create a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-custom.html>custom trust policy</a>
for the role to limit authorization to a specific group, project, branch, or tag.
For the full list of supported filtering types, see <a href=/ci/cloud_services/#configure-a-conditional-role-with-oidc-claims>Connect to cloud services</a>.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Federated&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::AWS_ACCOUNT:oidc-provider/gitlab.example.com&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=s2>&#34;sts:AssumeRoleWithWebIdentity&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Condition&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;StringEquals&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;gitlab.example.com:sub&#34;</span><span class=p>:</span> <span class=s2>&#34;project_path:mygroup/myproject:ref_type:branch:ref:main&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>After the role is created, attach a policy defining permissions to an AWS service (S3, EC2, Secrets Manager).</p><h2 id=retrieve-temporary-credentials>Retrieve temporary credentials</h2><p>After you configure the OIDC and role, the GitLab CI/CD job can retrieve a temporary credential from <a href=https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html>AWS Security Token Service (STS)</a>.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>assume role</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id_tokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>GITLAB_OIDC_TOKEN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>aud</span><span class=p>:</span><span class=w> </span><span class=l>https://gitlab.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># this is split out for correct exit code handling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>&gt;</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      aws_sts_output=$(aws sts assume-role-with-web-identity
</span></span></span><span class=line><span class=cl><span class=sd>      --role-arn ${ROLE_ARN}
</span></span></span><span class=line><span class=cl><span class=sd>      --role-session-name &#34;GitLabRunner-${CI_PROJECT_ID}-${CI_PIPELINE_ID}&#34;
</span></span></span><span class=line><span class=cl><span class=sd>      --web-identity-token ${GITLAB_OIDC_TOKEN}
</span></span></span><span class=line><span class=cl><span class=sd>      --duration-seconds 3600
</span></span></span><span class=line><span class=cl><span class=sd>      --query &#39;Credentials.[AccessKeyId,SecretAccessKey,SessionToken]&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      --output text)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>export $(printf &#34;AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s&#34; $aws_sts_output)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>aws sts get-caller-identity</span></span></span></code></pre></div></div><ul><li><code>ROLE_ARN</code>: The role ARN defined in this <a href=/ci/cloud_services/aws/#configure-a-role-and-trust>step</a>.</li><li><code>GITLAB_OIDC_TOKEN</code>: An OIDC <a href=/ci/secrets/id_token_authentication/>ID token</a>.</li></ul><h2 id=working-examples>Working examples</h2><ul><li>See this <a href=https://gitlab.com/guided-explorations/aws/configure-openid-connect-in-aws>reference project</a> for provisioning OIDC in AWS using Terraform and a sample script to retrieve temporary credentials.</li><li><a href=https://gitlab.com/guided-explorations/aws/oidc-and-multi-account-deployment-with-ecs>OIDC and Multi-Account Deployment with GitLab and ECS</a>.</li><li>AWS Partner (APN) Blog: <a href=https://aws.amazon.com/blogs/apn/setting-up-openid-connect-with-gitlab-ci-cd-to-provide-secure-access-to-environments-in-aws-accounts/>Setting up OpenID Connect with GitLab CI/CD</a>.</li><li><a href="https://www.youtube.com/watch?v=xWQGADDVn8g">GitLab at AWS re:Inforce 2023: Secure GitLab CD pipelines to AWS w/ OpenID and JWT</a>.</li></ul><h2 id=configure-a-non-public-gitlab-instance>Configure a non-public GitLab instance</h2><div class="availability gl-pl-4 gl-mb-5"><ul class="gl-list-none gl-p-0 gl-m-0"><li><span class=gl-font-bold>Tier</span>: Free, Premium, Ultimate</li><li><span class=gl-font-bold>Offering</span>: GitLab Self-Managed</li></ul></div><div class="collapsible-section gl-my-5"><button class="gl-align-middle gl-text-left gl-border-0 gl-pl-0" type=button aria-expanded=false aria-controls=collapsible-4 aria-label="Toggle section" data-toggle=collapse data-target=#collapsible-4>History<span class="gl-ml-2 icon"></span></button><div id=collapsible-4 class="collapsible-list collapse" aria-hidden=true><ul><li><a href=https://gitlab.com/gitlab-org/gitlab/-/issues/391928>Introduced</a> in GitLab 18.1</li></ul></div></div><div class="alert alert-type-warning gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>This workaround is an advanced configuration option with security considerations to understand.
You must be careful to correctly sync the OpenID configuration and the public keys from your private
GitLab Self-Managed instance to a publicly available location such as an S3 bucket.
You must also ensure that the S3 bucket and files inside are properly secured.
Failing to properly secure the S3 bucket could lead to the takeover of any cloud accounts
associated with this OpenID Connect identity.</p></div></div><p>If your GitLab instance is not publicly accessible, configuring OpenID Connect in AWS
is not possible by default. You can use a workaround to make some specific configuration publicly
accessible, enabling OpenID Connect configuration for the instance:</p><ol><li><p>Store authentication details for your GitLab instance at a publicly available location,
for example in S3 files:</p><ul><li>Host the OpenID configuration for your instance in an S3 file. The configuration is available at
<code>/.well-known/openid-configuration</code>, like <code>http://gitlab.example.com/.well-known/openid-configuration</code>.
Update the <code>issuer:</code> and <code>jwks_uri:</code> values in the configuration file to point to the publicly available locations.</li><li>Host the public keys for your instance URL in an S3 file. The keys are available at available at
<code>/oauth/discovery/keys</code>, like <code>http://gitlab.example.com/oauth/discovery/keys</code>.</li></ul><p>For example:</p><ul><li>OpenID configuration file: <code>https://example-oidc-configuration-s3-bucket.s3.eu-north-1.amazonaws.com/.well-known/openid-configuration</code>.</li><li>JWKS (JSON Web Key Sets): <code>https://example-oidc-configuration-s3-bucket.s3.eu-north-1.amazonaws.com/oauth/discovery/keys</code>.</li><li>The issuer claim <code>iss:</code> in the ID Tokens and the <code>issuer:</code> value in the OpenID configuration would be:
<code>https://example-oidc-configuration-s3-bucket.s3.eu-north-1.amazonaws.com</code></li></ul></li><li><p>Optional. Use an OpenID configuration validator like the <a href=https://www.oauth2.dev/tools/openid-configuration-validator>OpenID Configuration Endpoint Validator</a>
to validate your publicly available OpenID configuration.</p></li><li><p>Configure a custom issuer claim for your ID tokens. By default, GitLab ID tokens
have the issuer claim <code>iss:</code> set as the address of your GitLab instance, for example: <code>http://gitlab.example.com</code>.</p></li><li><p>Update the issuer URL:</p><div data-vue-app=docs-tabs><div class=tab><button class=tab-title>Linux package (Omnibus)</button><div class=tab-content><ol><li><p>Edit <code>/etc/gitlab/gitlab.rb</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=ruby class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>gitlab_rails</span><span class=o>[</span><span class=s1>&#39;ci_id_tokens_issuer_url&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=s1>&#39;public_url_with_openid_configuration_and_keys&#39;</span></span></span></code></pre></div></div></li><li><p>Save the file and <a href=/administration/restart_gitlab/#reconfigure-a-linux-package-installation>reconfigure GitLab</a> for the changes to take effect.</p></li></ol></div></div><div class=tab><button class=tab-title>Helm chart (Kubernetes)</button><div class=tab-content><ol><li><p>Export the Helm values:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm get values gitlab &gt; gitlab_values.yaml</span></span></code></pre></div></div></li><li><p>Edit <code>gitlab_values.yaml</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>appConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ciIdTokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>issuerUrl</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;public_url_with_openid_configuration_and_keys&#39;</span></span></span></code></pre></div></div></li><li><p>Save the file and apply the new values:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm upgrade -f gitlab_values.yaml gitlab gitlab/gitlab</span></span></code></pre></div></div></li></ol></div></div><div class=tab><button class=tab-title>Docker</button><div class=tab-content><ol><li><p>Edit <code>docker-compose.yml</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.6&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gitlab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>GITLAB_OMNIBUS_CONFIG</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;ci_id_tokens_issuer_url&#39;] = &#39;public_url_with_openid_configuration_and_keys&#39;</span></span></span></code></pre></div></div></li><li><p>Save the file and restart GitLab:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker compose up -d</span></span></code></pre></div></div></li></ol></div></div><div class=tab><button class=tab-title>Self-compiled (source)</button><div class=tab-content><ol><li><p>Edit <code>/home/git/gitlab/config/gitlab.yml</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w> </span><span class=nt>production</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>ci_id_tokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>issuer_url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;public_url_with_openid_configuration_and_keys&#39;</span></span></span></code></pre></div></div></li><li><p>Save the file and <a href=/administration/restart_gitlab/#self-compiled-installations>reconfigure GitLab</a>
for the changes to take effect.</p></li></ol></div></div></div></li><li><p>Run the <a href=/administration/raketasks/tokens/#validate-custom-issuer-url-configuration-for-cicd-id-tokens><code>ci:validate_id_token_configuration</code> Rake task</a>
to validate the CI/CD ID token configuration.</p></li></ol><h2 id=troubleshooting>Troubleshooting</h2><h3 id=error-not-authorized-to-perform-stsassumerolewithwebidentity>Error: <code>Not authorized to perform sts:AssumeRoleWithWebIdentity</code></h3><p>If you see this error:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=plaintext class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>An error occurred (AccessDenied) when calling the AssumeRoleWithWebIdentity operation:
</span></span><span class=line><span class=cl>Not authorized to perform sts:AssumeRoleWithWebIdentity</span></span></code></pre></div></div><p>It can occur for multiple reasons:</p><ul><li>The cloud administrator has not configured the project to use OIDC with GitLab.</li><li>The role is restricted from being run on the branch or tag. See <a href=/ci/cloud_services/>configure a conditional role</a>.</li><li><code>StringEquals</code> is used instead of <code>StringLike</code> when using a wildcard condition. See <a href=https://gitlab.com/guided-explorations/aws/configure-openid-connect-in-aws/-/issues/2#note_852901934>related issue</a>.</li></ul><h3 id=could-not-connect-to-openid-configuration-of-provider-error><code>Could not connect to openid configuration of provider</code> error</h3><p>After adding the Identity Provider in AWS IAM, you might get the following error:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=plaintext class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Your request has a problem. Please see the following details.
</span></span><span class=line><span class=cl>  - Could not connect to openid configuration of provider: `https://gitlab.example.com`</span></span></code></pre></div></div><p>This error occurs when the OIDC identity provider&rsquo;s issuer presents a certificate chain
that&rsquo;s out of order, or includes duplicate or additional certificates.</p><p>Verify your GitLab instance&rsquo;s certificate chain. The chain must start with the domain or issuer URL,
then the intermediate certificate, and end with the root certificate. Use this command to
review the certificate chain, replacing <code>gitlab.example.com</code> with your GitLab hostname:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=p>|</span> /opt/gitlab/embedded/bin/openssl s_client -connect gitlab.example.com:443</span></span></code></pre></div></div><h3 id=couldnt-retrieve-verification-key-from-your-identity-provider-error><code>Couldn't retrieve verification key from your identity provider</code> error</h3><p>You might receive an error similar to:</p><ul><li><code>An error occurred (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Couldn't retrieve verification key from your identity provider, please reference AssumeRoleWithWebIdentity documentation for requirements</code></li></ul><p>This error might be because:</p><ul><li>The <code>.well_known</code> URL and <code>jwks_uri</code> of the identity provider (IdP) are inaccessible from the public internet.</li><li>A custom firewall is blocking the requests.</li><li>There&rsquo;s latency of more than 5 seconds in API requests from the IdP to reach the AWS STS endpoint.</li><li>STS is making too many requests to your <code>.well_known</code> URL or the <code>jwks_uri</code> of the IdP.</li></ul><p>As documented in the <a href=https://repost.aws/knowledge-center/iam-sts-invalididentitytoken>AWS Knowledge Center article for this error</a>,
your GitLab instance needs to be publicly accessible so that the <code>.well_known</code> URL and <code>jwks_uri</code> can be resolved.
If this is not possible, for example if your GitLab instance is in an offline environment,
see how to <a href=/ci/cloud_services/aws/#configure-a-non-public-gitlab-instance>configure a non-public GitLab instance</a></p></div><div data-vue-app=back-to-top-button></div></div><div class="feedback gl-min-h-8" data-ga-section=feedback data-elastic-exclude><div data-component=docs-feedback></div></div></div><aside class=sidebar-right><div data-ga-section=toc data-vue-app=toc></div></aside></div></main><footer data-ga-section=footer><section data-ga-section=footer><div id=footer class="footer-section container gl-grid gl-grid-cols-2 gl-grid-rows-3 gl-grid-rows-auto gl-gap-8 lg:gl-grid-cols-5 lg:gl-grid-rows-1 lg:gl-justify-items-center gl-px-8 gl-py-8 lg:gl-py-10"><div class="gl-col-span-2 lg:gl-col-span-1 gl-row-start-1"><div class="docs-title gl-flex gl-items-center"><a href=/><img src=/gitlab-logo-footer.svg alt="GitLab Docs logo" class=logo width=176 height=24></a></div><ul class="docs-social gl-list-none gl-flex"><li><a href=https://www.facebook.com/gitlab class=facebook><span class=gl-sr-only>Facebook</span></a></li><li><a href=https://www.linkedin.com/company/gitlab-com class=linkedin><span class=gl-sr-only>LinkedIn</span></a></li><li><a href=https://twitter.com/gitlab class=twitter><span class=gl-sr-only>Twitter</span></a></li><li><a href=https://www.youtube.com/channel/UCnMGQ8QHMAnVIsI3xJrihhg class=youtube><span class=gl-sr-only>YouTube</span></a></li></ul><a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel="license noopener noreferrer" class=gl-mt-0><img src=/by-sa.svg alt="Creative Commons License" width=80 height=15></a></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Company</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/company/>About GitLab</a></li><li><a href=https://about.gitlab.com/pricing/>View pricing</a></li><li><a href=https://about.gitlab.com/free-trial/>Try GitLab for free</a></li></ul></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Feedback</div><ul class="gl-list-none gl-p-0"><li><a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/ci/cloud_services/aws/_index.md>View page source</a></li><li><a href=https://gitlab.com/-/ide/project/gitlab-org/gitlab/edit/master/-/doc/ci/cloud_services/aws/_index.md>Edit in web IDE</a></li><li><a href=https://about.gitlab.com/community/contribute/>Contribute to GitLab</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/new?issuable_template=Documentation">Suggest updates</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Help & Community</div><ul class="gl-list-none gl-p-0"><li><a href=https://university.gitlab.com/pages/certifications>Get certified</a></li><li><a href=https://about.gitlab.com/support/>Get support</a></li><li><a href="https://forum.gitlab.com/new-topic?title=topic%20title&amp;body=topic%20body&amp;tags=docs-feedback">Post on the GitLab forum</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Resources</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/terms/>Terms</a></li><li><a href=https://about.gitlab.com/privacy/>Privacy statement</a></li><li><a href=/legal/use_generative_ai/>Use of generative AI</a></li><li><a href=/legal/licensing_policy/>Acceptable use of user licenses</a></li><li><button id=ot-sdk-btn class=ot-sdk-show-settings></button></li></ul></div></div></section></footer><script type=module src=/vite/main.js></script><script async>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NJXWQL")</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJXWQL" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script async>(function(){var e,t=!1;function n(){t===!1&&(t=!0,Munchkin.init("194-VVC-221",{useBeaconAPI:!0}))}e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://munchkin.marketo.net/munchkin.js",e.onreadystatechange=function(){(this.readyState=="complete"||this.readyState=="loaded")&&n()},e.onload=n,document.getElementsByTagName("head")[0].appendChild(e)})()</script><script async src=https://cdn.bizible.com/scripts/bizible.js></script><script async>_linkedin_partner_id="30694",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id),function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",t.parentNode.insertBefore(e,t)}()</script><noscript><img height=1 width=1 style=display:none alt src="https://dc.ads.linkedin.com/collect/?pid=30694&fmt=gif"></noscript></body></html>