<!doctype html><html lang=en-us dir=ltr><head><script src=https://cdn.cookielaw.org/consent/7f944245-c5cd-4eed-a90e-dd955adfdd08/OtAutoBlock.js></script><script src=https://cdn.cookielaw.org/scripttemplates/otSDKStub.js data-domain-script=7f944245-c5cd-4eed-a90e-dd955adfdd08></script><script type=text/javascript>function OptanonWrapper(){}</script><script>const callback=(e)=>{for(const t of e)t.type==="childList"&&t.addedNodes.forEach(e=>{e.nodeName==="IMG"&&document.querySelectorAll('img:not([src^="http"]):not([data-ot-ignore])').forEach(e=>{e.setAttribute("data-ot-ignore","")})})},config={attributes:!0,childList:!0,subtree:!0,attributeFilter:["src"]},observer=new MutationObserver(callback);observer.observe(document.documentElement,config)</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-NJXWQL"),gtag("consent","default",{analytics_storage:"granted",ad_storage:"granted",functionality_storage:"granted",wait_for_update:500}),gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied",functionality_storage:"denied",region:["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE","IS","LI","NO","GB","PE","RU"],wait_for_update:500}),window.geofeed=e=>{dataLayer.push({event:"OneTrustCountryLoad",oneTrustCountryId:e.country.toString()})};const json=document.createElement("script");json.setAttribute("src","https://geolocation.onetrust.com/cookieconsentpub/v1/geo/location/geofeed"),document.head.appendChild(json)</script><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Configure OpenID Connect with GCP Workload Identity Federation | GitLab Docs</title><link rel=icon href=/favicon.ico sizes=any><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifests/manifest.webmanifest><meta name=theme-color content="#FC6D26"><link rel=canonical href=https://docs.gitlab.com/ci/cloud_services/google_cloud/><meta name=description content="GitLab product documentation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"GitLab Docs","url":"https://docs.gitlab.com/"}</script><link rel=preload href=/gitlab_ui/fonts/GitLabSans.woff2 type=font/woff2 as=font crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabSans-Italic.woff2 crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabMono.woff2 crossorigin><link rel=stylesheet href=/gitlab_ui/ui/index.css><link rel=stylesheet href=/vite/main.css><link rel=stylesheet href=/css/syntax-dark.min.css id=syntax-dark-theme><link rel=stylesheet href=/css/syntax-light.min.css id=syntax-light-theme><script>(function(){const p="gitlab-docs-theme",g="gitlab-docs-layout",e={LIGHT:"light",DARK:"dark",AUTO:"auto"},i={FIXED:"fixed",FLUID:"fluid"},d="light",f="fixed";let r=!1;const t=localStorage?.getItem(p),m=localStorage?.getItem(g),l=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?e.DARK:e.LIGHT;function h(){return t&&(t===e.LIGHT||t===e.DARK)?t:(t===e.AUTO&&(r=!0),l||d)}function u(){return m===i.FLUID?i.FLUID:f}const s=h(),c=u(),n=document.documentElement;n.classList.remove("gl-dark","gl-light"),n.classList.add(s===e.DARK?"gl-dark":"gl-light"),c===i.FLUID&&(n.classList.add("fluid"),n.classList.remove("fixed"));const a=document.getElementById("syntax-dark-theme"),o=document.getElementById("syntax-light-theme");a&&o&&(s===e.DARK?(a.disabled=!1,o.disabled=!0):(a.disabled=!0,o.disabled=!1)),window.__initialTheme=r?e.AUTO:s,window.__initialLayout=c})()</script><meta name=gitlab_docs_base_url content="/"><meta name=gitlab_docs_page_owner data-stage="Software Supply Chain Security" data-group="Pipeline Security"><meta class=elastic name=gitlab_docs_version content="18.6"><meta class=elastic name=gitlab_docs_section content="use_gitlab"><meta class=elastic name=gitlab_docs_breadcrumbs content="Use GitLab › Use CI/CD to build your application › Pipeline security › Connect to cloud services"><script>window.pageMetadata={trail:[{path:"user/",title:"Use GitLab"},{path:"topics/build_your_application/",title:"Use CI/CD to build your application"},{path:"ci/pipeline_security/",title:"Pipeline security"},{path:"ci/cloud_services/",title:"Connect to cloud services"},{path:"ci/cloud_services/google_cloud/",title:"Configure OpenID Connect with Google Cloud"}]}</script><meta name=gitlab_docs_legacy_path content="/ee/ci/cloud_services/google_cloud/index.html"><meta name=gitlab_docs_hugo_launch_version content="17.9"><script>const ELASTIC_CLOUD_ID="gitlab-docs-website:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDQwZTQyYTQzMTJiZjQyMzNiMzBiZTg0MTU5YjlkNmE1JGMxODg4Y2U5OTY0YzQzZjc5ZjQ1YTk5NDZmMjI0ODg0",ELASTIC_KEY="cDFpLWJaSUJXVHBqWWI4VGZKN3M6eENBSjl4WDRSRnlCUW94ajRQazhLQQ==",ELASTIC_INDEX="search-gitlab-docs-hugo"</script><script type=module src=/vite/elastic_search.js></script><script type=module src=/vite/history.js></script><script>const FS_IDENTIFIER="AIzaSyCLdi3jHHjkmLji9D8uj_RNPMHcdrYoIW4",RECAPTCHA_PUBLIC_KEY="6Le4R3UrAAAAALsIlK_siq0_UhPD-0rD-ImF1gfO"</script><meta name=google-site-verification content="AcGSBNaKDWnLgcYotlVibGy6STm2Y6_KJSaRxrA90xY"><meta name=google-site-verification content="6eFQOFLxYAer08ROqc3I-SAi44F9NmvH7PrUUBR3oCI"><meta name=google-site-verification content="xAUTWp3CDg-tU1LVVwsM9OrVhLR7L3SmiyKzkOuPNos"><meta name=google-site-verification content="F0zzwaMpiyWFcPQ1Lqu18qN3EnuQsqFXbySl_29yvHs"><meta name=google-site-verification content="nwo1bVaU0t9TZxZyM-aOI6-CofaH9GRL-uBPbdREWgc"><meta name=google-site-verification content="rWoHrtHEmIX0t28oOb1ZEDMYZb_EZA6rr6ZOl5otEPI"><meta name=google-site-verification content="fSxr8-uslxcuFL0N-oECp3Tm0RPNEGX97wbdayKOEL8"><meta name=google-site-verification content="ISxyLVnZqU8oY3jwrK7EO9o-2DOTvLJwPse7bZz6yhs"><meta name=google-site-verification content="x1WspIvz3ZHqS0gezfX_P-qiRDOeP2Oyrd68zrU2ErI"><meta name=google-site-verification content="DfXB2Za52GT3zs_vuLIAL4Mi3M3K4qxXcg7MAs0CUqo"><meta name=google-site-verification content="BCEBC2LC7A1NzO9Com1oBrWK88tV_QXfUL0i9mwXPL0"><meta name=google-site-verification content="a2lNcHMorfS43aoISjZt5_BBPo-H1UaTKMQdBgZO9iY"><meta name=google-site-verification content="0s16pP9MelY6wDHRf-izXb5pwLU01IogP-Uc_e8f3GU"><meta name=google-site-verification content="H474RNof35Xp8fLg02fZbg9Dzxdtfch6vtcjzpmUraU"><meta name=google-site-verification content="E0FlhpgBGeE7d1pQ6amdcIWPMDLDeu15-HLQVoDTguE"><meta name=google-site-verification content="opQd7_rXtPy-pX5CO_XZiztzeQEsXnB3j6Y1_dZAizA"><meta name=google-site-verification content="06Kq4AoXdmBOjOAkbPvnYGtSxnn4Q9QBqEO55PLlw5c"><meta name=google-site-verification content="djBBokRFSWV_VRlSE51V5TZSPzMC6hml5l-Sb22WglE"><meta name=google-site-verification content="UOW6nOsvbyMeIySuamzbws4kNC_WqehamWfoxxtKjZ8"><meta name=google-site-verification content="hXU1Gsdba74DUbvbdUHRl9o0cQeiwXIhAdIllOG6p8E"><meta name=google-site-verification content="YFeHIAPk9lE76ubVMeq4P0sQVnzo2-a4k1oU_bPY8yE"><meta name=google-site-verification content="h8ICI4eDkvXmYaGDuLTLoWuXnLn-KUkChqYB-roMRsw"><meta name=google-site-verification content="9QW7feFNlCpMLPm7vAWEU-v14vdzb0Bb3RAk-8e_a18"><meta name=google-site-verification content="26kXLBOjaYRb2UwzWTDl1I1nzA2NxMunhp7SUtxGV6E"><meta name=google-site-verification content="jr3C8t6vKGPyN9GV3esdHY_xGYyQaUNznIl-Un2RObA"><meta name=google-site-verification content="WdlBpRU0ec1ieKqrTY_772OhG23FY45VQ4Lv9DyLJ_Y"><meta name=google-site-verification content="n9i6B9q4Xjr_etK2nQGZH1msoo7vIv9SXV8SQLOUA7c"><meta name=zd-site-verification content="ony3w7hk1vs6tfyrc51mld"><meta name=zd-site-verification content="gtuq65qdzt6n31viazi6hj"></head><body data-elastic-exclude><nav data-ga-section=header data-elastic-exclude><div class="header-wrapper gl-w-full gl-fixed gl-z-4"><div class=header><div class="header-top gl-flex gl-items-center"><a href=#skipTarget class="gl-sr-only skip-link">Skip to main content</a>
<a class=navbar-logo href=/><span class=gl-sr-only>Go to GitLab Docs homepage</span></a><div class="mobile-header gl-w-full gl-text-base"><div class=mobile-header-overlay></div><div class="header-right collapse gl-z-4 gl-border-t lg:gl-border-0"><div class="search-wrapper lg:gl-ml-4 lg:gl-grow"><div class="js-elastic-search-form gl-spinner-container"><span role=status aria-label=Loading class="gl-ml-3 gl-align-text-bottom! gl-spinner gl-spinner gl-spinner-sm"></span></div></div><div class="gl-flex gl-flex-col gl-gap-3 gl-mt-5 lg:gl-mt-0 lg:gl-flex-row lg:gl-items-center gl-ml-auto"><a class="whats-new gl-button btn-default btn-default-tertiary gl-hidden lg:gl-block" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a><div data-vue-app=versions-menu></div><div data-vue-app=appearance-toggle class="gl-hidden lg:gl-block"></div><div class="gl-flex gl-justify-evenly lg:gl-justify-normal gl-items-center gl-gap-5"><a class="whats-new gl-button btn-default btn-default-tertiary gl-w-full lg:gl-hidden hover:gl-no-underline" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a>
<a class="free-trial-btn cta-button gl-button btn-confirm gl-w-full hover:gl-no-underline" href="https://gitlab.com/-/trial_registrations/new?glm_source=docs.gitlab.com&amp;amp;glm_content=navigation-cta-docs" target=_blank rel="noopener noreferrer" role=button>Get free trial</a></div></div></div></div><button class="navbar-toggle gl-button btn-default lg:gl-hidden" data-toggle=collapse data-target=.header-right>
<span class=navbar-toggle-icon></span>
<span class=gl-sr-only>Toggle menu</span></button></div><div class="header-bottom gl-border-t lg:gl-border-b"><ul class="subheader-menu gl-hidden lg:gl-flex gl-list-none gl-text-base gl-space-x-5 gl-py-4 gl-pl-0 gl-mb-0"><li><a href=/user/ class=active>Use GitLab</a></li><li><a href=/user/gitlab_duo/>GitLab Duo</a></li><li><a href=/api/>Extend</a></li><li><a href=/install/>Install</a></li><li><a href=/administration/>Administer</a></li><li><a href=/subscriptions/>Subscribe</a></li><li><a href=/development/>Contribute</a></li><li><a href=/solutions/>Solutions</a></li></ul></div></div></div></nav><main data-ga-section=content-body><div id=js-version-banner></div><div class="template-single gl-flex gl-h-full"><div class=side-nav data-ga-section=side-nav data-vue-app=sidebar-menu></div><div data-pagefind-body class=main-content><div class=docs-content><div class="gl-flex gl-h-5 gl-items-center gl-my-6"><div data-vue-app=open-sidebar></div><div data-vue-app=breadcrumb-nav></div></div><hr class="gl-border-t gl-px-5 lg:gl-hidden"><div class="gl-pt-4 gl-mt-4 lg:gl-pt-0 lg:gl-mt-0 lg:gl-border-t-0"><h1 id=skipTarget class=gl-mb-6>Configure OpenID Connect with GCP Workload Identity Federation</h1></div><div data-elastic-include><div class="availability gl-pl-4 gl-mb-5"><ul class="gl-list-none gl-p-0 gl-m-0"><li><span class=gl-font-bold>Tier</span>: Free, Premium, Ultimate</li><li><span class=gl-font-bold>Offering</span>: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li></ul></div><div class="alert alert-type-warning gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p><code>CI_JOB_JWT_V2</code> was <a href=/update/deprecations/#old-versions-of-json-web-tokens-are-deprecated>deprecated in GitLab 15.9</a>
and is scheduled to be removed in GitLab 17.0. Use <a href=/ci/secrets/id_token_authentication/>ID tokens</a> instead.</p></div></div><p>This tutorial demonstrates authenticating to Google Cloud from a GitLab CI/CD job
using a JSON Web Token (JWT) token and Workload Identity Federation. This configuration
generates on-demand, short-lived credentials without needing to store any secrets.</p><p>To get started, configure OpenID Connect (OIDC) for identity federation between GitLab
and Google Cloud. For more information on using OIDC with GitLab, read
<a href=/ci/cloud_services/>Connect to cloud services</a>.</p><p>This tutorial assumes you have a Google Cloud account and a Google Cloud project.
Your account must have at least the <strong>workload identity pool Admin</strong> permission
on the Google Cloud project.</p><div class="alert alert-type-note gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>If you would prefer to use a Terraform module and a CI/CD template instead of this tutorial,
see <a href=https://about.gitlab.com/blog/2023/06/28/introduction-of-oidc-modules-for-integration-between-google-cloud-and-gitlab-ci/>How OIDC can simplify authentication of GitLab CI/CD pipelines with Google Cloud</a>.</p></div></div><p>To complete this tutorial:</p><ol><li><a href=/ci/cloud_services/google_cloud/#create-the-google-cloud-workload-identity-pool>Create the Google Cloud workload identity pool</a>.</li><li><a href=/ci/cloud_services/google_cloud/#create-a-workload-identity-provider>Create a workload identity provider</a>.</li><li><a href=/ci/cloud_services/google_cloud/#grant-permissions-for-service-account-impersonation>Grant permissions for service account impersonation</a>.</li><li><a href=/ci/cloud_services/google_cloud/#retrieve-a-temporary-credential>Retrieve a temporary credential</a>.</li></ol><h2 id=create-the-google-cloud-workload-identity-pool>Create the Google Cloud workload identity pool</h2><p><a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-other-clouds#create_the_workload_identity_pool_and_provider>Create a new Google Cloud workload identity pool</a> with the following options:</p><ul><li><strong>Name</strong>: Human-friendly name for the workload identity pool, such as <code>GitLab</code>.</li><li><strong>Pool ID</strong>: Unique ID in the Google Cloud project for the workload identity pool,
such as <code>gitlab</code>. This value is used to refer to the pool and appears in URLs.</li><li><strong>Description</strong>: Optional. A description of the pool.</li><li><strong>Enabled Pool</strong>: Ensure this option is <code>true</code>.</li></ul><p>We recommend creating a single pool per GitLab installation per Google Cloud project. If you have multiple GitLab repositories and CI/CD jobs on the same GitLab instance, they can authenticate using different providers against the same pool.</p><h2 id=create-a-workload-identity-provider>Create a workload identity provider</h2><p><a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-other-clouds#create_the_workload_identity_pool_and_provider>Create a new Google Cloud workload identity provider</a>
inside the workload identity pool created in the previous step, using the following options:</p><ul><li><p><strong>Provider type</strong>: OpenID Connect (OIDC).</p></li><li><p><strong>Provider name</strong>: Human-friendly name for the workload identity provider,
such as <code>gitlab/gitlab</code>.</p></li><li><p><strong>Provider ID</strong>: Unique ID in the pool for the workload identity provider,
such as <code>gitlab-gitlab</code>. This value is used to refer to the provider, and appears in URLs.</p></li><li><p><strong>Issuer (URL)</strong>: The address of your GitLab instance, such as <code>https://gitlab.com/</code> or
<code>https://gitlab.example.com/</code>.</p><ul><li>The address must use the <code>https://</code> protocol.</li><li>The address must end in a trailing slash.</li></ul></li><li><p><strong>Audiences</strong>: Manually set the allowed audiences list to the address of your
GitLab instance, such as <code>https://gitlab.com</code> or <code>https://gitlab.example.com</code>.</p><ul><li>The address must use the <code>https://</code> protocol.</li><li>The address must not end in a trailing slash.</li></ul></li><li><p><strong>Provider attributes mapping</strong>: Create the following mappings, where <code>attribute.X</code> is the
name of the attribute to be included as a claim in the Google token, and <code>assertion.X</code>
is the value to extract from the <a href=/ci/cloud_services/#id-token-authentication-for-cloud-services>GitLab claim</a>:</p><table><thead><tr><th>Attribute (on Google)</th><th>Assertion (from GitLab)</th></tr></thead><tbody><tr><td><code>google.subject</code></td><td><code>assertion.sub</code></td></tr><tr><td><code>attribute.X</code></td><td><code>assertion.X</code></td></tr></tbody></table><p>You can also <a href=https://cloud.google.com/iam/docs/workload-identity-federation#mapping>build complex attributes</a>
using Common Expression Language (CEL).</p><p>You must map every attribute that you want to use for permission granting. For example, if you want to map permissions in the next step based on the user&rsquo;s email address, you must map <code>attribute.user_email</code> to <code>assertion.user_email</code>.</p></li></ul><div class="alert alert-type-warning gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>For projects hosted on GitLab.com, GCP requires you to
<a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-deployment-pipelines#gitlab-saas_2>limit access to only tokens issued by your GitLab group</a>.</p></div></div><h2 id=grant-permissions-for-service-account-impersonation>Grant permissions for Service Account impersonation</h2><p>Creating the workload identity pool and workload identity provider defines the authentication
into Google Cloud. At this point, you can authenticate from GitLab CI/CD job into Google Cloud.
However, you have no permissions on Google Cloud (authorization).</p><p>To grant your GitLab CI/CD job permissions on Google Cloud, you must:</p><ol><li><a href=https://cloud.google.com/iam/docs/service-accounts-create>Create a Google Cloud Service Account</a>.
You can use whatever name and ID you prefer.</li><li><a href=https://cloud.google.com/iam/docs/granting-changing-revoking-access>Grant IAM permissions</a> to your
service account on Google Cloud resources. These permissions vary significantly based on
your use case. In general, grant this service account the permissions on your Google Cloud
project and resources you want your GitLab CI/CD job to be able to use. For example, if you needed to upload a file to a Google Cloud Storage bucket in your GitLab CI/CD job, you would grant this Service Account the <code>roles/storage.objectCreator</code> role on your Cloud Storage bucket.</li><li><a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-other-clouds#impersonate>Grant the external identity permissions</a>
to impersonate that Service Account. This step enables a GitLab CI/CD job to authorize
to Google Cloud, via Service Account impersonation. This step grants an IAM permission
on the Service Account itself, giving the external identity permissions to act as that
service account. External identities are expressed using the <code>principalSet://</code> protocol.</li></ol><p>Much like the previous step, this step depends heavily on your desired configuration.
For example, to allow a GitLab CI/CD job to impersonate a Service Account named
<code>my-service-account</code> if the GitLab CI/CD job was initiated by a GitLab user with the
username <code>chris</code>, you would grant the <code>roles/iam.workloadIdentityUser</code> IAM role to the
external identity on <code>my-service-account</code>. The external identity takes the format:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=plaintext class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/attribute.user_login/chris</span></span></code></pre></div></div><p>where <code>PROJECT_NUMBER</code> is your Google Cloud project number, and <code>POOL_ID</code> is the
ID (not name) of the workload identity pool created in the first section.</p><p>This configuration also assumes you added <code>user_login</code> as an attribute mapped from
the assertion in the previous section.</p><h2 id=retrieve-a-temporary-credential>Retrieve a temporary credential</h2><p>After you configure the OIDC and role, the GitLab CI/CD job can retrieve a temporary credential from the
<a href=https://cloud.google.com/iam/docs/reference/sts/rest>Google Cloud Security Token Service (STS)</a>.</p><p>Add <code>id_tokens</code> to your CI/CD job:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>job</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id_tokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>GITLAB_OIDC_TOKEN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>aud</span><span class=p>:</span><span class=w> </span><span class=l>https://gitlab.example.com</span></span></span></code></pre></div></div><p>Get temporary credentials using the ID token:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>PAYLOAD</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>cat <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;audience&#34;: &#34;//iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;grantType&#34;: &#34;urn:ietf:params:oauth:grant-type:token-exchange&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;requestedTokenType&#34;: &#34;urn:ietf:params:oauth:token-type:access_token&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;scope&#34;: &#34;https://www.googleapis.com/auth/cloud-platform&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;subjectTokenType&#34;: &#34;urn:ietf:params:oauth:token-type:jwt&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;subjectToken&#34;: &#34;${GITLAB_OIDC_TOKEN}&#34;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=k>)</span><span class=s2>&#34;</span></span></span></code></pre></div></div><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>FEDERATED_TOKEN</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl --fail <span class=s2>&#34;https://sts.googleapis.com/v1/token&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --header <span class=s2>&#34;Accept: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --header <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --data <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PAYLOAD</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=p>|</span> jq -r <span class=s1>&#39;.access_token&#39;</span>
</span></span><span class=line><span class=cl><span class=k>)</span><span class=s2>&#34;</span></span></span></code></pre></div></div><p>Where:</p><ul><li><code>PROJECT_NUMBER</code> is your Google Cloud project number (not name).</li><li><code>POOL_ID</code> is the ID of the workload identity pool created in the first section.</li><li><code>PROVIDER_ID</code> is the ID of the workload identity provider created in the second section.</li><li><code>GITLAB_OIDC_TOKEN</code> is an OIDC <a href=/ci/secrets/id_token_authentication/>ID token</a>.</li></ul><p>You can then use the resulting federated token to impersonate the service account created
in the previous section:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>ACCESS_TOKEN</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl --fail <span class=s2>&#34;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/SERVICE_ACCOUNT_EMAIL:generateAccessToken&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --header <span class=s2>&#34;Accept: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --header <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --header <span class=s2>&#34;Authorization: Bearer FEDERATED_TOKEN&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --data <span class=s1>&#39;{&#34;scope&#34;: [&#34;https://www.googleapis.com/auth/cloud-platform&#34;]}&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=p>|</span> jq -r <span class=s1>&#39;.accessToken&#39;</span>
</span></span><span class=line><span class=cl><span class=k>)</span><span class=s2>&#34;</span></span></span></code></pre></div></div><p>Where:</p><ul><li><code>SERVICE_ACCOUNT_EMAIL</code> is the full email address of the service account to impersonate,
created in the previous section.</li><li><code>FEDERATED_TOKEN</code> is the federated token retrieved from the previous step.</li></ul><p>The result is a Google Cloud OAuth 2.0 access token, which you can use to authenticate to
most Google Cloud APIs and services when used as a bearer token. You can also pass this
value to the <code>gcloud</code> CLI by setting the environment variable <code>CLOUDSDK_AUTH_ACCESS_TOKEN</code>.</p><h2 id=working-example>Working example</h2><p>Review this
<a href=https://gitlab.com/guided-explorations/gcp/configure-openid-connect-in-gcp>reference project</a>
for provisioning OIDC in GCP using Terraform and a sample script to retrieve temporary credentials.</p><h2 id=troubleshooting>Troubleshooting</h2><ul><li><p>When debugging <code>curl</code> responses, install the latest version of curl. Use <code>--fail-with-body</code>
instead of <code>-f</code>. This command prints the entire body, which can contain helpful error messages.</p></li><li><p>For more information, see <a href=https://cloud.google.com/iam/docs/troubleshooting-workload-identity-federation>Troubleshoot Workload Identity Federation</a>.</p></li></ul></div><div data-vue-app=back-to-top-button></div></div><div class="feedback gl-min-h-8" data-ga-section=feedback data-elastic-exclude><div data-component=docs-feedback></div></div></div><aside class=sidebar-right><div data-ga-section=toc data-vue-app=toc></div></aside></div></main><footer data-ga-section=footer><section data-ga-section=footer><div id=footer class="footer-section container gl-grid gl-grid-cols-2 gl-grid-rows-3 gl-grid-rows-auto gl-gap-8 lg:gl-grid-cols-5 lg:gl-grid-rows-1 lg:gl-justify-items-center gl-px-8 gl-py-8 lg:gl-py-10"><div class="gl-col-span-2 lg:gl-col-span-1 gl-row-start-1"><div class="docs-title gl-flex gl-items-center"><a href=/><img src=/gitlab-logo-footer.svg alt="GitLab Docs logo" class=logo width=176 height=24></a></div><ul class="docs-social gl-list-none gl-flex"><li><a href=https://www.facebook.com/gitlab class=facebook><span class=gl-sr-only>Facebook</span></a></li><li><a href=https://www.linkedin.com/company/gitlab-com class=linkedin><span class=gl-sr-only>LinkedIn</span></a></li><li><a href=https://twitter.com/gitlab class=twitter><span class=gl-sr-only>Twitter</span></a></li><li><a href=https://www.youtube.com/channel/UCnMGQ8QHMAnVIsI3xJrihhg class=youtube><span class=gl-sr-only>YouTube</span></a></li></ul><a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel="license noopener noreferrer" class=gl-mt-0><img src=/by-sa.svg alt="Creative Commons License" width=80 height=15></a></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Company</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/company/>About GitLab</a></li><li><a href=https://about.gitlab.com/pricing/>View pricing</a></li><li><a href=https://about.gitlab.com/free-trial/>Try GitLab for free</a></li></ul></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Feedback</div><ul class="gl-list-none gl-p-0"><li><a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/ci/cloud_services/google_cloud/_index.md>View page source</a></li><li><a href=https://gitlab.com/-/ide/project/gitlab-org/gitlab/edit/master/-/doc/ci/cloud_services/google_cloud/_index.md>Edit in web IDE</a></li><li><a href=https://about.gitlab.com/community/contribute/>Contribute to GitLab</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/new?issuable_template=Documentation">Suggest updates</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Help & Community</div><ul class="gl-list-none gl-p-0"><li><a href=https://university.gitlab.com/pages/certifications>Get certified</a></li><li><a href=https://about.gitlab.com/support/>Get support</a></li><li><a href="https://forum.gitlab.com/new-topic?title=topic%20title&amp;body=topic%20body&amp;tags=docs-feedback">Post on the GitLab forum</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Resources</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/terms/>Terms</a></li><li><a href=https://about.gitlab.com/privacy/>Privacy statement</a></li><li><a href=/legal/use_generative_ai/>Use of generative AI</a></li><li><a href=/legal/licensing_policy/>Acceptable use of user licenses</a></li><li><button id=ot-sdk-btn class=ot-sdk-show-settings></button></li></ul></div></div></section></footer><script type=module src=/vite/main.js></script><script async>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NJXWQL")</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJXWQL" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script async>(function(){var e,t=!1;function n(){t===!1&&(t=!0,Munchkin.init("194-VVC-221",{useBeaconAPI:!0}))}e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://munchkin.marketo.net/munchkin.js",e.onreadystatechange=function(){(this.readyState=="complete"||this.readyState=="loaded")&&n()},e.onload=n,document.getElementsByTagName("head")[0].appendChild(e)})()</script><script async src=https://cdn.bizible.com/scripts/bizible.js></script><script async>_linkedin_partner_id="30694",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id),function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",t.parentNode.insertBefore(e,t)}()</script><noscript><img height=1 width=1 style=display:none alt src="https://dc.ads.linkedin.com/collect/?pid=30694&fmt=gif"></noscript></body></html>