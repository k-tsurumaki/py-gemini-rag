<!doctype html><html lang=en-us dir=ltr><head><script src=https://cdn.cookielaw.org/consent/7f944245-c5cd-4eed-a90e-dd955adfdd08/OtAutoBlock.js></script><script src=https://cdn.cookielaw.org/scripttemplates/otSDKStub.js data-domain-script=7f944245-c5cd-4eed-a90e-dd955adfdd08></script><script type=text/javascript>function OptanonWrapper(){}</script><script>const callback=(e)=>{for(const t of e)t.type==="childList"&&t.addedNodes.forEach(e=>{e.nodeName==="IMG"&&document.querySelectorAll('img:not([src^="http"]):not([data-ot-ignore])').forEach(e=>{e.setAttribute("data-ot-ignore","")})})},config={attributes:!0,childList:!0,subtree:!0,attributeFilter:["src"]},observer=new MutationObserver(callback);observer.observe(document.documentElement,config)</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-NJXWQL"),gtag("consent","default",{analytics_storage:"granted",ad_storage:"granted",functionality_storage:"granted",wait_for_update:500}),gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied",functionality_storage:"denied",region:["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE","IS","LI","NO","GB","PE","RU"],wait_for_update:500}),window.geofeed=e=>{dataLayer.push({event:"OneTrustCountryLoad",oneTrustCountryId:e.country.toString()})};const json=document.createElement("script");json.setAttribute("src","https://geolocation.onetrust.com/cookieconsentpub/v1/geo/location/geofeed"),document.head.appendChild(json)</script><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Use Docker to build Docker images | GitLab Docs</title><link rel=icon href=/favicon.ico sizes=any><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifests/manifest.webmanifest><meta name=theme-color content="#FC6D26"><link rel=canonical href=https://docs.gitlab.com/ci/docker/using_docker_build/><meta name=description content="GitLab product documentation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"GitLab Docs","url":"https://docs.gitlab.com/"}</script><link rel=preload href=/gitlab_ui/fonts/GitLabSans.woff2 type=font/woff2 as=font crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabSans-Italic.woff2 crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabMono.woff2 crossorigin><link rel=stylesheet href=/gitlab_ui/ui/index.css><link rel=stylesheet href=/vite/main.css><link rel=stylesheet href=/css/syntax-dark.min.css id=syntax-dark-theme><link rel=stylesheet href=/css/syntax-light.min.css id=syntax-light-theme><script>(function(){const p="gitlab-docs-theme",g="gitlab-docs-layout",e={LIGHT:"light",DARK:"dark",AUTO:"auto"},i={FIXED:"fixed",FLUID:"fluid"},d="light",f="fixed";let r=!1;const t=localStorage?.getItem(p),m=localStorage?.getItem(g),l=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?e.DARK:e.LIGHT;function h(){return t&&(t===e.LIGHT||t===e.DARK)?t:(t===e.AUTO&&(r=!0),l||d)}function u(){return m===i.FLUID?i.FLUID:f}const s=h(),c=u(),n=document.documentElement;n.classList.remove("gl-dark","gl-light"),n.classList.add(s===e.DARK?"gl-dark":"gl-light"),c===i.FLUID&&(n.classList.add("fluid"),n.classList.remove("fixed"));const a=document.getElementById("syntax-dark-theme"),o=document.getElementById("syntax-light-theme");a&&o&&(s===e.DARK?(a.disabled=!1,o.disabled=!0):(a.disabled=!0,o.disabled=!1)),window.__initialTheme=r?e.AUTO:s,window.__initialLayout=c})()</script><meta name=gitlab_docs_base_url content="/"><meta name=gitlab_docs_page_owner data-stage=Verify data-group="Pipeline Execution"><meta class=elastic name=gitlab_docs_version content="18.6"><meta class=elastic name=gitlab_docs_section content="use_gitlab"><meta class=elastic name=gitlab_docs_breadcrumbs content="Use GitLab › Use CI/CD to build your application › Jobs › Docker"><script>window.pageMetadata={trail:[{path:"user/",title:"Use GitLab"},{path:"topics/build_your_application/",title:"Use CI/CD to build your application"},{path:"ci/jobs/",title:"Jobs"},{path:"ci/docker/",title:"Docker"},{path:"ci/docker/using_docker_build/",title:"Use Docker to build Docker images"}]}</script><meta name=gitlab_docs_legacy_path content="/ee/ci/docker/using_docker_build.html"><meta name=gitlab_docs_hugo_launch_version content="17.9"><script>const ELASTIC_CLOUD_ID="gitlab-docs-website:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDQwZTQyYTQzMTJiZjQyMzNiMzBiZTg0MTU5YjlkNmE1JGMxODg4Y2U5OTY0YzQzZjc5ZjQ1YTk5NDZmMjI0ODg0",ELASTIC_KEY="cDFpLWJaSUJXVHBqWWI4VGZKN3M6eENBSjl4WDRSRnlCUW94ajRQazhLQQ==",ELASTIC_INDEX="search-gitlab-docs-hugo"</script><script type=module src=/vite/elastic_search.js></script><script type=module src=/vite/history.js></script><script>const FS_IDENTIFIER="AIzaSyCLdi3jHHjkmLji9D8uj_RNPMHcdrYoIW4",RECAPTCHA_PUBLIC_KEY="6Le4R3UrAAAAALsIlK_siq0_UhPD-0rD-ImF1gfO"</script><meta name=google-site-verification content="AcGSBNaKDWnLgcYotlVibGy6STm2Y6_KJSaRxrA90xY"><meta name=google-site-verification content="6eFQOFLxYAer08ROqc3I-SAi44F9NmvH7PrUUBR3oCI"><meta name=google-site-verification content="xAUTWp3CDg-tU1LVVwsM9OrVhLR7L3SmiyKzkOuPNos"><meta name=google-site-verification content="F0zzwaMpiyWFcPQ1Lqu18qN3EnuQsqFXbySl_29yvHs"><meta name=google-site-verification content="nwo1bVaU0t9TZxZyM-aOI6-CofaH9GRL-uBPbdREWgc"><meta name=google-site-verification content="rWoHrtHEmIX0t28oOb1ZEDMYZb_EZA6rr6ZOl5otEPI"><meta name=google-site-verification content="fSxr8-uslxcuFL0N-oECp3Tm0RPNEGX97wbdayKOEL8"><meta name=google-site-verification content="ISxyLVnZqU8oY3jwrK7EO9o-2DOTvLJwPse7bZz6yhs"><meta name=google-site-verification content="x1WspIvz3ZHqS0gezfX_P-qiRDOeP2Oyrd68zrU2ErI"><meta name=google-site-verification content="DfXB2Za52GT3zs_vuLIAL4Mi3M3K4qxXcg7MAs0CUqo"><meta name=google-site-verification content="BCEBC2LC7A1NzO9Com1oBrWK88tV_QXfUL0i9mwXPL0"><meta name=google-site-verification content="a2lNcHMorfS43aoISjZt5_BBPo-H1UaTKMQdBgZO9iY"><meta name=google-site-verification content="0s16pP9MelY6wDHRf-izXb5pwLU01IogP-Uc_e8f3GU"><meta name=google-site-verification content="H474RNof35Xp8fLg02fZbg9Dzxdtfch6vtcjzpmUraU"><meta name=google-site-verification content="E0FlhpgBGeE7d1pQ6amdcIWPMDLDeu15-HLQVoDTguE"><meta name=google-site-verification content="opQd7_rXtPy-pX5CO_XZiztzeQEsXnB3j6Y1_dZAizA"><meta name=google-site-verification content="06Kq4AoXdmBOjOAkbPvnYGtSxnn4Q9QBqEO55PLlw5c"><meta name=google-site-verification content="djBBokRFSWV_VRlSE51V5TZSPzMC6hml5l-Sb22WglE"><meta name=google-site-verification content="UOW6nOsvbyMeIySuamzbws4kNC_WqehamWfoxxtKjZ8"><meta name=google-site-verification content="hXU1Gsdba74DUbvbdUHRl9o0cQeiwXIhAdIllOG6p8E"><meta name=google-site-verification content="YFeHIAPk9lE76ubVMeq4P0sQVnzo2-a4k1oU_bPY8yE"><meta name=google-site-verification content="h8ICI4eDkvXmYaGDuLTLoWuXnLn-KUkChqYB-roMRsw"><meta name=google-site-verification content="9QW7feFNlCpMLPm7vAWEU-v14vdzb0Bb3RAk-8e_a18"><meta name=google-site-verification content="26kXLBOjaYRb2UwzWTDl1I1nzA2NxMunhp7SUtxGV6E"><meta name=google-site-verification content="jr3C8t6vKGPyN9GV3esdHY_xGYyQaUNznIl-Un2RObA"><meta name=google-site-verification content="WdlBpRU0ec1ieKqrTY_772OhG23FY45VQ4Lv9DyLJ_Y"><meta name=google-site-verification content="n9i6B9q4Xjr_etK2nQGZH1msoo7vIv9SXV8SQLOUA7c"><meta name=zd-site-verification content="ony3w7hk1vs6tfyrc51mld"><meta name=zd-site-verification content="gtuq65qdzt6n31viazi6hj"></head><body data-elastic-exclude><nav data-ga-section=header data-elastic-exclude><div class="header-wrapper gl-w-full gl-fixed gl-z-4"><div class=header><div class="header-top gl-flex gl-items-center"><a href=#skipTarget class="gl-sr-only skip-link">Skip to main content</a>
<a class=navbar-logo href=/><span class=gl-sr-only>Go to GitLab Docs homepage</span></a><div class="mobile-header gl-w-full gl-text-base"><div class=mobile-header-overlay></div><div class="header-right collapse gl-z-4 gl-border-t lg:gl-border-0"><div class="search-wrapper lg:gl-ml-4 lg:gl-grow"><div class="js-elastic-search-form gl-spinner-container"><span role=status aria-label=Loading class="gl-ml-3 gl-align-text-bottom! gl-spinner gl-spinner gl-spinner-sm"></span></div></div><div class="gl-flex gl-flex-col gl-gap-3 gl-mt-5 lg:gl-mt-0 lg:gl-flex-row lg:gl-items-center gl-ml-auto"><a class="whats-new gl-button btn-default btn-default-tertiary gl-hidden lg:gl-block" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a><div data-vue-app=versions-menu></div><div data-vue-app=appearance-toggle class="gl-hidden lg:gl-block"></div><div class="gl-flex gl-justify-evenly lg:gl-justify-normal gl-items-center gl-gap-5"><a class="whats-new gl-button btn-default btn-default-tertiary gl-w-full lg:gl-hidden hover:gl-no-underline" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a>
<a class="free-trial-btn cta-button gl-button btn-confirm gl-w-full hover:gl-no-underline" href="https://gitlab.com/-/trial_registrations/new?glm_source=docs.gitlab.com&amp;amp;glm_content=navigation-cta-docs" target=_blank rel="noopener noreferrer" role=button>Get free trial</a></div></div></div></div><button class="navbar-toggle gl-button btn-default lg:gl-hidden" data-toggle=collapse data-target=.header-right>
<span class=navbar-toggle-icon></span>
<span class=gl-sr-only>Toggle menu</span></button></div><div class="header-bottom gl-border-t lg:gl-border-b"><ul class="subheader-menu gl-hidden lg:gl-flex gl-list-none gl-text-base gl-space-x-5 gl-py-4 gl-pl-0 gl-mb-0"><li><a href=/user/ class=active>Use GitLab</a></li><li><a href=/user/gitlab_duo/>GitLab Duo</a></li><li><a href=/api/>Extend</a></li><li><a href=/install/>Install</a></li><li><a href=/administration/>Administer</a></li><li><a href=/subscriptions/>Subscribe</a></li><li><a href=/development/>Contribute</a></li><li><a href=/solutions/>Solutions</a></li></ul></div></div></div></nav><main data-ga-section=content-body><div id=js-version-banner></div><div class="template-single gl-flex gl-h-full"><div class=side-nav data-ga-section=side-nav data-vue-app=sidebar-menu></div><div data-pagefind-body class=main-content><div class=docs-content><div class="gl-flex gl-h-5 gl-items-center gl-my-6"><div data-vue-app=open-sidebar></div><div data-vue-app=breadcrumb-nav></div></div><hr class="gl-border-t gl-px-5 lg:gl-hidden"><div class="gl-pt-4 gl-mt-4 lg:gl-pt-0 lg:gl-mt-0 lg:gl-border-t-0"><h1 id=skipTarget class=gl-mb-6>Use Docker to build Docker images</h1></div><div data-elastic-include><div class="availability gl-pl-4 gl-mb-5"><ul class="gl-list-none gl-p-0 gl-m-0"><li><span class=gl-font-bold>Tier</span>: Free, Premium, Ultimate</li><li><span class=gl-font-bold>Offering</span>: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li></ul></div><p>You can use GitLab CI/CD with Docker to create Docker images.
For example, you can create a Docker image of your application,
test it, and push it to a container registry.</p><p>To run Docker commands in your CI/CD jobs, you must configure
GitLab Runner to support <code>docker</code> commands. This method requires <code>privileged</code> mode.</p><p>If you want to build Docker images without enabling <code>privileged</code> mode on the runner,
you can use a <a href=/ci/docker/using_docker_build/#docker-alternatives>Docker alternative</a>.</p><h2 id=enable-docker-commands-in-your-cicd-jobs>Enable Docker commands in your CI/CD jobs</h2><p>To enable Docker commands for your CI/CD jobs, you can use:</p><ul><li><a href=/ci/docker/using_docker_build/#use-the-shell-executor>The shell executor</a></li><li><a href=/ci/docker/using_docker_build/#use-docker-in-docker>Docker-in-Docker</a></li><li><a href=/ci/docker/using_docker_build/#use-docker-socket-binding>Docker socket binding</a></li><li><a href=/ci/docker/using_docker_build/#use-docker-pipe-binding>Docker pipe binding</a></li></ul><h3 id=use-the-shell-executor>Use the shell executor</h3><p>To include Docker commands in your CI/CD jobs, you can configure your runner to
use the <code>shell</code> executor. In this configuration, the <code>gitlab-runner</code> user runs
the Docker commands, but needs permission to do so.</p><ol><li><p><a href=https://gitlab.com/gitlab-org/gitlab-runner/#installation>Install</a> GitLab Runner.</p></li><li><p><a href=https://docs.gitlab.com/runner/register/>Register</a> a runner.
Select the <code>shell</code> executor. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo gitlab-runner register -n <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --url <span class=s2>&#34;https://gitlab.com/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --registration-token REGISTRATION_TOKEN <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --executor shell <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --description <span class=s2>&#34;My Runner&#34;</span></span></span></code></pre></div></div></li><li><p>On the server where GitLab Runner is installed, install Docker Engine.
View a list of <a href=https://docs.docker.com/engine/install/>supported platforms</a>.</p></li><li><p>Add the <code>gitlab-runner</code> user to the <code>docker</code> group:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo usermod -aG docker gitlab-runner</span></span></code></pre></div></div></li><li><p>Verify that <code>gitlab-runner</code> has access to Docker:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo -u gitlab-runner -H docker info</span></span></code></pre></div></div></li><li><p>In GitLab, add <code>docker info</code> to <code>.gitlab-ci.yml</code> to verify that Docker is working:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build_image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><p>You can now use <code>docker</code> commands (and install Docker Compose if needed).</p><p>When you add <code>gitlab-runner</code> to the <code>docker</code> group, you effectively grant <code>gitlab-runner</code> full root permissions.
For more information, see <a href=https://blog.zopyx.com/on-docker-security-docker-group-considered-harmful/>security of the <code>docker</code> group</a>.</p><h3 id=use-docker-in-docker>Use Docker-in-Docker</h3><p>&ldquo;Docker-in-Docker&rdquo; (<code>dind</code>) means:</p><ul><li>Your registered runner uses the <a href=https://docs.gitlab.com/runner/executors/docker.html>Docker executor</a> or
the <a href=https://docs.gitlab.com/runner/executors/kubernetes/>Kubernetes executor</a>.</li><li>The executor uses a <a href=https://hub.docker.com/_/docker/>container image of Docker</a>, provided
by Docker, to run your CI/CD jobs.</li></ul><p>The Docker image includes all of the <code>docker</code> tools and can run
the job script in context of the image in privileged mode.</p><p>You should use Docker-in-Docker with TLS enabled,
which is supported by <a href=/ci/runners/>GitLab.com instance runners</a>.</p><p>You should always pin a specific version of the image, like <code>docker:24.0.5</code>.
If you use a tag like <code>docker:latest</code>, you have no control over which version is used.
This can cause incompatibility problems when new versions are released.</p><h4 id=use-the-docker-executor-with-docker-in-docker>Use the Docker executor with Docker-in-Docker</h4><p>You can use the Docker executor to run jobs in a Docker container.</p><h5 id=docker-in-docker-with-tls-enabled-in-the-docker-executor>Docker-in-Docker with TLS enabled in the Docker executor</h5><p>The Docker daemon supports connections over TLS. TLS is the default in Docker 19.03.12 and later.</p><div class="alert alert-type-warning gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>This task enables <code>--docker-privileged</code>, which effectively disables the container&rsquo;s security mechanisms and exposes your host to privilege
escalation. This action can cause container breakout. For more information, see
<a href=https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities>runtime privilege and Linux capabilities</a>.</p></div></div><p>To use Docker-in-Docker with TLS enabled:</p><ol><li><p>Install <a href=https://docs.gitlab.com/runner/install/>GitLab Runner</a>.</p></li><li><p>Register GitLab Runner from the command line. Use <code>docker</code> and <code>privileged</code>
mode:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo gitlab-runner register -n <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --url <span class=s2>&#34;https://gitlab.com/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --registration-token REGISTRATION_TOKEN <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --executor docker <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --description <span class=s2>&#34;My Docker Runner&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tag-list <span class=s2>&#34;tls-docker-runner&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-image <span class=s2>&#34;docker:24.0.5-cli&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-privileged <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-volumes <span class=s2>&#34;/certs/client&#34;</span></span></span></code></pre></div></div><ul><li>This command registers a new runner to use the <code>docker:24.0.5-cli</code> image (if none is specified at the job level).
To start the build and service containers, it uses the <code>privileged</code> mode.
If you want to use Docker-in-Docker,
you must always use <code>privileged = true</code> in your Docker containers.</li><li>This command mounts <code>/certs/client</code> for the service and build
container, which is needed for the Docker client to use the
certificates in that directory. For more information, see <a href=https://hub.docker.com/_/docker/>the Docker image documentation</a>.</li></ul><p>The previous command creates a <code>config.toml</code> entry similar to the following example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://gitlab.com/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>token</span> <span class=p>=</span> <span class=nx>TOKEN</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>tls_verify</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;docker:24.0.5-cli&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>disable_cache</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/certs/client&#34;</span><span class=p>,</span> <span class=s2>&#34;/cache&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>s3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>gcs</span><span class=p>]</span></span></span></code></pre></div></div></li><li><p>You can now use <code>docker</code> in the job script. You should include the <code>docker:24.0.5-dind</code> service:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:24.0.5-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When you use the dind service, you must instruct Docker to talk with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># the daemon started inside of the service. The daemon is available</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># with a network connection instead of the default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># /var/run/docker.sock socket. Docker 19.03 does this automatically</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># by setting the DOCKER_HOST in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://github.com/docker-library/docker/blob/d45051476babc297257df490d22cbd806f1b11e4/19.03/docker-entrypoint.sh#L23-L29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The &#39;docker&#39; hostname is the alias of the service container as described at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://docs.gitlab.com/ee/ci/services/#accessing-the-services.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Specify to Docker where to create the certificates. Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># creates them automatically on boot, and creates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># `/certs/client` to share between the service and job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># container, thanks to volume mount from config.toml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tls-docker-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h5 id=use-a-unix-socket-on-a-shared-volume-between-docker-in-docker-and-build-container>Use a Unix socket on a shared volume between Docker-in-Docker and build container</h5><p>Directories defined in <code>volumes = ["/certs/client", "/cache"]</code> in the
<a href=/ci/docker/using_docker_build/#docker-in-docker-with-tls-enabled-in-the-docker-executor>Docker-in-Docker with TLS enabled in the Docker executor</a>
approach are <a href=https://docs.gitlab.com/runner/executors/docker.html#persistent-storage>persistent between builds</a>.
If multiple CI/CD jobs using a Docker executor runner have Docker-in-Docker services enabled, then each job
writes to the directory path. This approach might result in a conflict.</p><p>To address this conflict, use a Unix socket on a volume shared between the Docker-in-Docker service and the build container.
This approach improves performance and establishes a secure connection between the service and client.</p><p>The following is a sample <code>config.toml</code> with temporary volume shared between build and service containers:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://gitlab.com/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>token</span> <span class=p>=</span> <span class=nx>TOKEN</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;docker:24.0.5-cli&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/runner/services/docker&#34;</span><span class=p>]</span> <span class=c># Temporary volume shared between build and service containers.</span></span></span></code></pre></div></div><p>The Docker-in-Docker service creates a <code>docker.sock</code>. The Docker client connects to <code>docker.sock</code> through a Docker Unix socket volume.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>job</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This variable is shared by both the DinD service and Docker client.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># For the service, it will instruct DinD to create `docker.sock` here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># For the client, it tells the Docker client which Docker Unix socket to connect to.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>DOCKER_HOST</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;unix:///runner/services/docker/docker.sock&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:24.0.5-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker version</span></span></span></code></pre></div></div><h5 id=docker-in-docker-with-tls-disabled-in-the-docker-executor>Docker-in-Docker with TLS disabled in the Docker executor</h5><p>Sometimes there are legitimate reasons to disable TLS.
For example, you have no control over the GitLab Runner configuration
that you are using.</p><ol><li><p>Register GitLab Runner from command line. Use <code>docker</code> and <code>privileged</code> mode:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo gitlab-runner register -n <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --url <span class=s2>&#34;https://gitlab.com/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --registration-token REGISTRATION_TOKEN <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --executor docker <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --description <span class=s2>&#34;My Docker Runner&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tag-list <span class=s2>&#34;no-tls-docker-runner&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-image <span class=s2>&#34;docker:24.0.5-cli&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-privileged</span></span></code></pre></div></div><p>The previous command creates a <code>config.toml</code> entry similar to the following example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://gitlab.com/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>token</span> <span class=p>=</span> <span class=nx>TOKEN</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>tls_verify</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;docker:24.0.5-cli&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>disable_cache</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/cache&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>s3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>gcs</span><span class=p>]</span></span></span></code></pre></div></div></li><li><p>Include the <code>docker:24.0.5-dind</code> service in the job script:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:24.0.5-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When using dind service, you must instruct docker to talk with the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># daemon started inside of the service. The daemon is available with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># a network connection instead of the default /var/run/docker.sock socket.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The &#39;docker&#39; hostname is the alias of the service container as described at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#accessing-the-services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_HOST</span><span class=p>:</span><span class=w> </span><span class=l>tcp://docker:2375</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># This instructs Docker not to start over TLS.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=kc>no</span>-<span class=l>tls-docker-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h5 id=docker-in-docker-with-proxy-enabled-in-the-docker-executor>Docker-in-Docker with proxy enabled in the Docker executor</h5><p>You might need to configure proxy settings to use the <code>docker push</code> command.</p><p>For more information, see <a href=https://docs.gitlab.com/runner/configuration/proxy.html#proxy-settings-when-using-dind-service>Proxy settings when using dind service</a>.</p><h4 id=use-the-kubernetes-executor-with-docker-in-docker>Use the Kubernetes executor with Docker-in-Docker</h4><p>You can use the <a href=https://docs.gitlab.com/runner/executors/kubernetes/>Kubernetes executor</a> to run jobs in a Docker container.</p><h5 id=docker-in-docker-with-tls-enabled-in-kubernetes>Docker-in-Docker with TLS enabled in Kubernetes</h5><p>To use Docker-in-Docker with TLS enabled in Kubernetes:</p><ol><li><p>Using the
<a href=https://docs.gitlab.com/runner/install/kubernetes.html>Helm chart</a>, update the
<a href=https://gitlab.com/gitlab-org/charts/gitlab-runner/-/blob/00c1a2098f303dffb910714752e9a981e119f5b5/values.yaml#L133-137><code>values.yml</code> file</a>
to specify a volume mount.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>runners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls-dind-kubernetes-runner&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [[runners]]
</span></span></span><span class=line><span class=cl><span class=sd>      [runners.kubernetes]
</span></span></span><span class=line><span class=cl><span class=sd>        image = &#34;ubuntu:20.04&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        privileged = true
</span></span></span><span class=line><span class=cl><span class=sd>      [[runners.kubernetes.volumes.empty_dir]]
</span></span></span><span class=line><span class=cl><span class=sd>        name = &#34;docker-certs&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        mount_path = &#34;/certs/client&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        medium = &#34;Memory&#34;</span></span></span></code></pre></div></div></li><li><p>Include the <code>docker:24.0.5-dind</code> service in the job:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>HEALTHCHECK_TCP_PORT</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2376&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When using dind service, you must instruct Docker to talk with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># the daemon started inside of the service. The daemon is available</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># with a network connection instead of the default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># /var/run/docker.sock socket.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_HOST</span><span class=p>:</span><span class=w> </span><span class=l>tcp://docker:2376</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The &#39;docker&#39; hostname is the alias of the service container as described at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://docs.gitlab.com/ee/ci/services/#accessing-the-services.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Specify to Docker where to create the certificates. Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># creates them automatically on boot, and creates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># `/certs/client` to share between the service and job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># container, thanks to volume mount from config.toml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># These are usually specified by the entrypoint, however the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Kubernetes executor doesn&#39;t run entrypoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4125</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_VERIFY</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_CERT_PATH</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$DOCKER_TLS_CERTDIR/client&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tls-dind-kubernetes-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h5 id=docker-in-docker-with-tls-disabled-in-kubernetes>Docker-in-Docker with TLS disabled in Kubernetes</h5><p>To use Docker-in-Docker with TLS disabled in Kubernetes, you must adapt the previous example to:</p><ul><li>Remove the <code>[[runners.kubernetes.volumes.empty_dir]]</code> section from the <code>values.yml</code> file.</li><li>Change the port from <code>2376</code> to <code>2375</code> with <code>DOCKER_HOST: tcp://docker:2375</code>.</li><li>Instruct Docker to start with TLS disabled with <code>DOCKER_TLS_CERTDIR: ""</code>.</li></ul><p>For example:</p><ol><li><p>Using the
<a href=https://docs.gitlab.com/runner/install/kubernetes.html>Helm chart</a>, update the
<a href=https://gitlab.com/gitlab-org/charts/gitlab-runner/-/blob/00c1a2098f303dffb910714752e9a981e119f5b5/values.yaml#L133-137><code>values.yml</code> file</a>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>runners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;no-tls-dind-kubernetes-runner&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [[runners]]
</span></span></span><span class=line><span class=cl><span class=sd>      [runners.kubernetes]
</span></span></span><span class=line><span class=cl><span class=sd>        image = &#34;ubuntu:20.04&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        privileged = true</span></span></span></code></pre></div></div></li><li><p>You can now use <code>docker</code> in the job script. You should include the
<code>docker:24.0.5-dind</code> service:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>HEALTHCHECK_TCP_PORT</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2375&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When using dind service, you must instruct Docker to talk with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># the daemon started inside of the service. The daemon is available</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># with a network connection instead of the default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># /var/run/docker.sock socket.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_HOST</span><span class=p>:</span><span class=w> </span><span class=l>tcp://docker:2375</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The &#39;docker&#39; hostname is the alias of the service container as described at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://docs.gitlab.com/ee/ci/services/#accessing-the-services.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># This instructs Docker not to start over TLS.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=kc>no</span>-<span class=l>tls-dind-kubernetes-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h4 id=known-issues-with-docker-in-docker>Known issues with Docker-in-Docker</h4><p>Docker-in-Docker is the recommended configuration, but you should be aware of the following issues:</p><ul><li><p><strong>The <code>docker-compose</code> command</strong>: This command is not available in this configuration by default.
To use <code>docker-compose</code> in your job scripts, follow the Docker Compose
<a href=https://docs.docker.com/compose/install/>installation instructions</a>.</p></li><li><p><strong>Cache</strong>: Each job runs in a new environment. Because every build gets its own instance of the Docker engine, concurrent jobs do not cause conflicts.
However, jobs can be slower because there&rsquo;s no caching of layers. See <a href=/ci/docker/using_docker_build/#make-docker-in-docker-builds-faster-with-docker-layer-caching>Docker layer caching</a>.</p></li><li><p><strong>Storage drivers</strong>: By default, earlier versions of Docker use the <code>vfs</code> storage driver,
which copies the file system for each job. Docker 17.09 and later use <code>--storage-driver overlay2</code>, which is
the recommended storage driver. See <a href=/ci/docker/using_docker_build/#use-the-overlayfs-driver>Using the OverlayFS driver</a> for details.</p></li><li><p><strong>Root file system</strong>: Because the <code>docker:24.0.5-dind</code> container and the runner container do not share their
root file system, you can use the job&rsquo;s working directory as a mount point for
child containers. For example, if you have files you want to share with a
child container, you could create a subdirectory under <code>/builds/$CI_PROJECT_PATH</code>
and use it as your mount point. For a more detailed explanation, see
<a href=https://gitlab.com/gitlab-org/gitlab-foss/-/issues/41227>issue #41227</a>.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>MOUNT_POINT</span><span class=p>:</span><span class=w> </span><span class=l>/builds/$CI_PROJECT_PATH/mnt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mkdir -p &#34;$MOUNT_POINT&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>docker run -v &#34;$MOUNT_POINT:/mnt&#34; my-docker-image</span></span></span></code></pre></div></div></li></ul><h3 id=use-docker-socket-binding>Use Docker socket binding</h3><p>To use Docker commands in your CI/CD jobs, you can bind-mount <code>/var/run/docker.sock</code> into the
build container. Docker is then available in the context of the image.</p><p>If you bind the Docker socket you can&rsquo;t use <code>docker:24.0.5-dind</code> as a service. Volume bindings also affect services,
making them incompatible.</p><h4 id=use-the-docker-executor-with-docker-socket-binding>Use the Docker executor with Docker socket binding</h4><p>To mount the Docker socket with the Docker executor, add <code>"/var/run/docker.sock:/var/run/docker.sock"</code> to the
<a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#volumes-in-the-runnersdocker-section>Volumes in the <code>[runners.docker]</code> section</a>.</p><ol><li><p>To mount <code>/var/run/docker.sock</code> while registering your runner, include the following options:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo gitlab-runner register <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --non-interactive <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --url <span class=s2>&#34;https://gitlab.com/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --registration-token REGISTRATION_TOKEN <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --executor <span class=s2>&#34;docker&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --description <span class=s2>&#34;docker-runner&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tag-list <span class=s2>&#34;socket-binding-docker-runner&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-image <span class=s2>&#34;docker:24.0.5-cli&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-volumes <span class=s2>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span></span></span></code></pre></div></div><p>The previous command creates a <code>config.toml</code> entry similar to the following example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://gitlab.com/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>token</span> <span class=p>=</span> <span class=nx>RUNNER_TOKEN</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>tls_verify</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;docker:24.0.5-cli&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>disable_cache</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span><span class=p>,</span> <span class=s2>&#34;/cache&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>Insecure</span> <span class=p>=</span> <span class=kc>false</span></span></span></code></pre></div></div></li><li><p>Use Docker in the job script:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>socket-binding-docker-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h4 id=use-the-kubernetes-executor-with-docker-socket-binding>Use the Kubernetes executor with Docker socket binding</h4><p>To mount the Docker socket with the Kubernetes executor, add <code>"/var/run/docker.sock"</code> to the
<a href=https://docs.gitlab.com/runner/executors/kubernetes/index.html#hostpath-volume>Volumes in the <code>[[runners.kubernetes.volumes.host_path]]</code> section</a>.</p><ol><li><p>To specify a volume mount, update the
<a href=https://gitlab.com/gitlab-org/charts/gitlab-runner/-/blob/00c1a2098f303dffb910714752e9a981e119f5b5/values.yaml#L133-137><code>values.yml</code> file</a>
by using <a href=https://docs.gitlab.com/runner/install/kubernetes.html>Helm chart</a>.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>runners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;socket-binding-kubernetes-runner&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [[runners]]
</span></span></span><span class=line><span class=cl><span class=sd>      [runners.kubernetes]
</span></span></span><span class=line><span class=cl><span class=sd>        image = &#34;ubuntu:20.04&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        privileged = false
</span></span></span><span class=line><span class=cl><span class=sd>      [runners.kubernetes]
</span></span></span><span class=line><span class=cl><span class=sd>        [[runners.kubernetes.volumes.host_path]]
</span></span></span><span class=line><span class=cl><span class=sd>          host_path = &#39;/var/run/docker.sock&#39;
</span></span></span><span class=line><span class=cl><span class=sd>          mount_path = &#39;/var/run/docker.sock&#39;
</span></span></span><span class=line><span class=cl><span class=sd>          name = &#39;docker-sock&#39;
</span></span></span><span class=line><span class=cl><span class=sd>          read_only = true</span></span></span></code></pre></div></div></li><li><p>Use Docker in the job script:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>socket-binding-kubernetes-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h4 id=known-issues-with-docker-socket-binding>Known issues with Docker socket binding</h4><p>When you use Docker socket binding, you avoid running Docker in privileged mode. However,
the implications of this method are:</p><ul><li><p>When you share the Docker daemon, you effectively disable
the container&rsquo;s security mechanisms and expose your host to privilege
escalation. This can cause container breakout. For example, if you run
<code>docker rm -f $(docker ps -a -q)</code> in a project, it removes the GitLab Runner
containers.</p></li><li><p>Concurrent jobs might not work. If your tests
create containers with specific names, they might conflict with each other.</p></li><li><p>Any containers created by Docker commands are siblings of the runner, rather
than children of the runner. This might cause complications for your workflow.</p></li><li><p>Sharing files and directories from the source repository into containers might not
work as expected. Volume mounting is done in the context of the host
machine, not the build container. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker run --rm -t -i -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/src:/home/app/src test-image:latest run_app_tests</span></span></code></pre></div></div></li></ul><p>You do not need to include the <code>docker:24.0.5-dind</code> service, like you do when
you use the Docker-in-Docker executor:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div><p>For complex Docker-in-Docker setups like <a href=/ci/testing/code_quality_codeclimate_scanning/>Code Quality scanning using CodeClimate</a>, you must match host and container paths for proper execution. For more details, see
<a href=/ci/testing/code_quality_codeclimate_scanning/#use-private-runners>Use private runners for CodeClimate-based scanning</a>.</p><h3 id=use-docker-pipe-binding>Use Docker pipe binding</h3><p>Windows Containers run Windows executables compiled for the Windows Server kernel and userland
(either windowsservercore or nanoserver). To build and run Windows containers, a Windows system
with container support is required.
For more information, see <a href=https://learn.microsoft.com/en-us/virtualization/windowscontainers/>Windows Containers</a>.</p><p>To use Docker pipe binding, you must install and run a Docker Engine on the host Windows Server operating system.
For more information, see <a href="https://learn.microsoft.com/en-us/virtualization/windowscontainers/quick-start/set-up-environment?tabs=dockerce#windows-server-1">Install Docker Community Edition (CE) on Windows Server</a>.</p><p>To use Docker commands in your Windows-based container CI/CD jobs, you can bind-mount <code>\\.\pipe\docker_engine</code>
into the launched executor container. Docker is then available in the context of the image.</p><p>The <a href=/ci/docker/using_docker_build/#use-docker-pipe-binding>Docker pipe binding in Windows</a> is similar to
<a href=/ci/docker/using_docker_build/#use-docker-socket-binding>Docker socket binding in Linux</a> and have similar
<a href=/ci/docker/using_docker_build/#known-issues-with-docker-pipe-binding>Known issues</a> as
<a href=/ci/docker/using_docker_build/#known-issues-with-docker-socket-binding>Known issues with Docker socket binding</a>.</p><p>A mandatory prerequisite for usage of Docker pipe binding is a Docker Engine installed and
running on the host Windows Server operating system.
See: <a href="https://learn.microsoft.com/en-us/virtualization/windowscontainers/quick-start/set-up-environment?tabs=dockerce#windows-server-2">Install Docker Community Edition (CE) on Windows Server</a></p><h4 id=use-the-docker-executor-with-docker-pipe-binding>Use the Docker executor with Docker pipe binding</h4><p>You can use the <a href=https://docs.gitlab.com/runner/executors/docker.html>Docker executor</a> to run jobs in a Windows-based container.</p><p>To mount the Docker pipe with the Docker executor, add <code>"\\.\pipe\docker_engine:\\.\pipe\docker_engine"</code> to the
<a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#volumes-in-the-runnersdocker-section>Volumes in the <code>[runners.docker]</code> section</a>.</p><ol><li><p>To mount <code>"\\.\pipe\docker_engine</code> while registering your runner, include the following options:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=powershell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.\</span><span class=nb>gitlab-runner</span><span class=p>.</span><span class=py>exe</span> <span class=n>register</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-non-interactive</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-url</span> <span class=s2>&#34;https://gitlab.com/&#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-registration-token</span> <span class=n>REGISTRATION_TOKEN</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-executor</span> <span class=s2>&#34;docker-windows&#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-description</span> <span class=s2>&#34;docker-windows-runner&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-tag-list</span> <span class=s2>&#34;docker-windows-runner&#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-docker-image</span> <span class=s2>&#34;docker:25-windowsservercore-ltsc2022&#34;</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>  <span class=p>-</span><span class=n>-docker-volumes</span> <span class=s2>&#34;\\.\pipe\docker_engine:\\.\pipe\docker_engine&#34;</span></span></span></code></pre></div></div><p>The previous command creates a <code>config.toml</code> entry similar to the following example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://gitlab.com/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>token</span> <span class=p>=</span> <span class=nx>RUNNER_TOKEN</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker-windows&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>tls_verify</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;docker:25-windowsservercore-ltsc2022&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>disable_cache</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;\\.\pipe\docker_engine:\\.\pipe\docker_engine&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>Insecure</span> <span class=p>=</span> <span class=kc>false</span></span></span></code></pre></div></div></li><li><p>Use Docker in the job script:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:25-windowsservercore-ltsc2022</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker-windows-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h4 id=use-the-kubernetes-executor-with-docker-pipe-binding>Use the Kubernetes executor with Docker pipe binding</h4><p>You can use the <a href=https://docs.gitlab.com/runner/executors/kubernetes.html>Kubernetes executor</a> to run jobs in a Windows-based container.</p><p>To use Kubernetes executor for Windows-based containers, you must include Windows nodes in your Kubernetes cluster.
For more information, see <a href=https://kubernetes.io/docs/concepts/windows/intro/>Windows containers in Kubernetes</a>.</p><p>You can use <a href=https://docs.gitlab.com/runner/executors/kubernetes/#example-for-windowsamd64>Runner operating in a Linux environment but targeting Windows nodes</a></p><p>To mount the Docker pipe with the Kubernetes executor, add <code>"\\.\pipe\docker_engine"</code> to the
<a href=https://docs.gitlab.com/runner/executors/kubernetes/index.html#hostpath-volume>Volumes in the <code>[[runners.kubernetes.volumes.host_path]]</code> section</a>.</p><ol><li><p>To specify a volume mount, update the
<a href=https://gitlab.com/gitlab-org/charts/gitlab-runner/-/blob/00c1a2098f303dffb910714752e9a981e119f5b5/values.yaml#L133-137><code>values.yml</code> file</a>
by using <a href=https://docs.gitlab.com/runner/install/kubernetes.html>Helm chart</a>.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>runners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubernetes-windows-runner&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [[runners]]
</span></span></span><span class=line><span class=cl><span class=sd>      executor = &#34;kubernetes&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      # The FF_USE_POWERSHELL_PATH_RESOLVER feature flag has to be enabled for PowerShell
</span></span></span><span class=line><span class=cl><span class=sd>      # to resolve paths for Windows correctly when Runner is operating in a Linux environment
</span></span></span><span class=line><span class=cl><span class=sd>      # but targeting Windows nodes.
</span></span></span><span class=line><span class=cl><span class=sd>      [runners.feature_flags]
</span></span></span><span class=line><span class=cl><span class=sd>        FF_USE_POWERSHELL_PATH_RESOLVER = true
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      [runners.kubernetes]
</span></span></span><span class=line><span class=cl><span class=sd>        [[runners.kubernetes.volumes.host_path]]
</span></span></span><span class=line><span class=cl><span class=sd>          host_path = &#39;\\.\pipe\docker_engine&#39;
</span></span></span><span class=line><span class=cl><span class=sd>          mount_path = &#39;\\.\pipe\docker_engine&#39;
</span></span></span><span class=line><span class=cl><span class=sd>          name = &#39;docker-pipe&#39;
</span></span></span><span class=line><span class=cl><span class=sd>          read_only = true
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        [runners.kubernetes.node_selector]
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;kubernetes.io/arch&#34; = &#34;amd64&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;kubernetes.io/os&#34; = &#34;windows&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;node.kubernetes.io/windows-build&#34; = &#34;10.0.20348&#34;</span></span></span></code></pre></div></div></li><li><p>Use Docker in the job script:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:25-windowsservercore-ltsc2022</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kubernetes-windows-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build -t my-docker-image .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker run my-docker-image /script/to/run/tests</span></span></span></code></pre></div></div></li></ol><h5 id=known-issues-with-aws-eks-kubernetes-cluster>Known issues with AWS EKS Kubernetes cluster</h5><p>When you migrate from <code>dockerd</code> to <code>containerd</code>, the AWS EKS bootstrapping script <code>Start-EKSBootstrap.ps1</code>
stops and disables the Docker Service. To work around this issue, rename the Docker Service after you
<a href="https://learn.microsoft.com/en-us/virtualization/windowscontainers/quick-start/set-up-environment?tabs=dockerce#windows-server-1">Install Docker Community Edition (CE) on Windows Server</a> with this script:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=powershell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Write-Output</span> <span class=s2>&#34;Rename the just installed Docker Engine Service from docker to dockerd&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Output</span> <span class=s2>&#34;because the Start-EKSBootstrap.ps1 stops and disables the docker Service as part of migration from dockerd to containerd&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Stop-Service</span> <span class=n>-Name</span> <span class=n>docker</span>
</span></span><span class=line><span class=cl><span class=n>dockerd</span> <span class=p>-</span><span class=n>-register-service</span> <span class=p>-</span><span class=n>-service-name</span> <span class=n>dockerd</span>
</span></span><span class=line><span class=cl><span class=nb>Start-Service</span> <span class=n>-Name</span> <span class=n>dockerd</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Output</span> <span class=s2>&#34;Ready to do Docker pipe binding on Windows EKS Node! :-)&#34;</span></span></span></code></pre></div></div><h4 id=known-issues-with-docker-pipe-binding>Known issues with Docker pipe binding</h4><p>Docker pipe binding has the same set of security and isolation issues as the <a href=/ci/docker/using_docker_build/#known-issues-with-docker-socket-binding>Known issues with Docker socket binding</a>.</p><h2 id=enable-registry-mirror-for-dockerdind-service>Enable registry mirror for <code>docker:dind</code> service</h2><p>When the Docker daemon starts inside the service container, it uses
the default configuration. You might want to configure a
<a href=https://docs.docker.com/docker-hub/mirror/>registry mirror</a> for
performance improvements and to ensure you do not exceed Docker Hub rate limits.</p><h3 id=the-service-in-the-gitlab-ciyml-file>The service in the <code>.gitlab-ci.yml</code> file</h3><p>You can append extra CLI flags to the <code>dind</code> service to set the registry
mirror:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker:24.0.5-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;--registry-mirror&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;https://registry-mirror.example.com&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># Specify the registry mirror to use</span></span></span></code></pre></div></div><h3 id=the-service-in-the-gitlab-runner-configuration-file>The service in the GitLab Runner configuration file</h3><p>If you are a GitLab Runner administrator, you can specify the <code>command</code> to configure the registry mirror
for the Docker daemon. The <code>dind</code> service must be defined for the
<a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnersdockerservices-section>Docker</a>
or <a href=https://docs.gitlab.com/runner/executors/kubernetes/#define-a-list-of-services>Kubernetes executor</a>.</p><p>Docker:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>[[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>.</span><span class=nx>services</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;docker:24.0.5-dind&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>command</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;--registry-mirror&#34;</span><span class=p>,</span> <span class=s2>&#34;https://registry-mirror.example.com&#34;</span><span class=p>]</span></span></span></code></pre></div></div><p>Kubernetes:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;kubernetes&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>[[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>services</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;docker:24.0.5-dind&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>command</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;--registry-mirror&#34;</span><span class=p>,</span> <span class=s2>&#34;https://registry-mirror.example.com&#34;</span><span class=p>]</span></span></span></code></pre></div></div><h3 id=the-docker-executor-in-the-gitlab-runner-configuration-file>The Docker executor in the GitLab Runner configuration file</h3><p>If you are a GitLab Runner administrator, you can use
the mirror for every <code>dind</code> service. Update the
<a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html>configuration</a>
to specify a <a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#volumes-in-the-runnersdocker-section>volume mount</a>.</p><p>For example, if you have a <code>/opt/docker/daemon.json</code> file with the following
content:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;registry-mirrors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://registry-mirror.example.com&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>Update the <code>config.toml</code> file to mount the file to
<code>/etc/docker/daemon.json</code>. This mounts the file for <strong>every</strong>
container created by GitLab Runner. The configuration is
detected by the <code>dind</code> service.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;alpine:3.12&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/opt/docker/daemon.json:/etc/docker/daemon.json:ro&#34;</span><span class=p>]</span></span></span></code></pre></div></div><h3 id=the-kubernetes-executor-in-the-gitlab-runner-configuration-file>The Kubernetes executor in the GitLab Runner configuration file</h3><p>If you are a GitLab Runner administrator, you can use
the mirror for every <code>dind</code> service. Update the
<a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html>configuration</a>
to specify a <a href=https://docs.gitlab.com/runner/executors/kubernetes/#configmap-volume>ConfigMap volume mount</a>.</p><p>For example, if you have a <code>/tmp/daemon.json</code> file with the following
content:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;registry-mirrors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;https://registry-mirror.example.com&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>Create a <a href=https://kubernetes.io/docs/concepts/configuration/configmap/>ConfigMap</a> with the content
of this file. You can do this with a command like:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create configmap docker-daemon --namespace gitlab-runner --from-file /tmp/daemon.json</span></span></code></pre></div></div><div class="alert alert-type-note gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>You must use the namespace that the Kubernetes executor for GitLab Runner uses to create job pods.</p></div></div><p>After the ConfigMap is created, you can update the <code>config.toml</code>
file to mount the file to <code>/etc/docker/daemon.json</code>. This update
mounts the file for <strong>every</strong> container created by GitLab Runner.
The <code>dind</code> service detects this configuration.</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;kubernetes&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;alpine:3.12&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>[[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>volumes</span><span class=p>.</span><span class=nx>config_map</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;docker-daemon&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>mount_path</span> <span class=p>=</span> <span class=s2>&#34;/etc/docker/daemon.json&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>sub_path</span> <span class=p>=</span> <span class=s2>&#34;daemon.json&#34;</span></span></span></code></pre></div></div><h2 id=authenticate-with-registry-in-docker-in-docker>Authenticate with registry in Docker-in-Docker</h2><p>When you use Docker-in-Docker, the <a href=/ci/docker/using_docker_images/#access-an-image-from-a-private-container-registry>standard authentication methods</a> do not work, because a fresh Docker daemon is started with the service. You should <a href=/ci/docker/authenticate_registry/>authenticate with registry</a>.</p><h2 id=make-docker-in-docker-builds-faster-with-docker-layer-caching>Make Docker-in-Docker builds faster with Docker layer caching</h2><p>When using Docker-in-Docker, Docker downloads all layers of your image every time you create a build. You can <a href=/ci/docker/docker_layer_caching/>make your builds faster with Docker layer caching</a>.</p><h2 id=use-the-overlayfs-driver>Use the OverlayFS driver</h2><div class="alert alert-type-note gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>The instance runners on GitLab.com use the <code>overlay2</code> driver by default.</p></div></div><p>By default, when using <code>docker:dind</code>, Docker uses the <code>vfs</code> storage driver, which
copies the file system on every run. You can avoid this disk-intensive operation by using a different driver, for example <code>overlay2</code>.</p><h3 id=requirements>Requirements</h3><ol><li><p>Ensure a recent kernel is used, preferably <code>>= 4.2</code>.</p></li><li><p>Check whether the <code>overlay</code> module is loaded:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo lsmod <span class=p>|</span> grep overlay</span></span></code></pre></div></div><p>If you see no result, then the module is not loaded. To load the module, use:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo modprobe overlay</span></span></code></pre></div></div><p>If the module loaded, you must make sure the module loads on reboot.
On Ubuntu systems, do this by adding the following line to <code>/etc/modules</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=plaintext class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>overlay</span></span></code></pre></div></div></li></ol><h3 id=use-the-overlayfs-driver-per-project>Use the OverlayFS driver per project</h3><p>You can enable the driver for each project individually by using the <code>DOCKER_DRIVER</code>
<a href=/ci/yaml/#variables>CI/CD variable</a> in <code>.gitlab-ci.yml</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_DRIVER</span><span class=p>:</span><span class=w> </span><span class=l>overlay2</span></span></span></code></pre></div></div><h3 id=use-the-overlayfs-driver-for-every-project>Use the OverlayFS driver for every project</h3><p>If you use your own <a href=https://docs.gitlab.com/runner/>runners</a>, you
can enable the driver for every project by setting the <code>DOCKER_DRIVER</code>
environment variable in the
<a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section><code>[[runners]]</code> section of the <code>config.toml</code> file</a>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>environment</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;DOCKER_DRIVER=overlay2&#34;</span><span class=p>]</span></span></span></code></pre></div></div><p>If you&rsquo;re running multiple runners, you must modify all configuration files.</p><p>Read more about the <a href=https://docs.gitlab.com/runner/configuration/>runner configuration</a>
and <a href=https://docs.docker.com/storage/storagedriver/overlayfs-driver/>using the OverlayFS storage driver</a>.</p><h2 id=docker-alternatives>Docker alternatives</h2><p>You can build container images without enabling privileged mode on your runner:</p><ul><li><a href=/ci/docker/using_buildkit/>BuildKit</a>: Includes rootless BuildKit options that eliminate Docker daemon dependency.</li><li><a href=/ci/docker/using_docker_build/#buildah-example>Buildah</a>: Build OCI-compliant images without requiring a Docker daemon.</li></ul><h3 id=buildah-example>Buildah example</h3><p>To use Buildah with GitLab CI/CD, you need <a href=https://docs.gitlab.com/runner/>a runner</a> with one
of the following executors:</p><ul><li><a href=https://docs.gitlab.com/runner/executors/kubernetes/>Kubernetes</a>.</li><li><a href=https://docs.gitlab.com/runner/executors/docker.html>Docker</a>.</li><li><a href=https://docs.gitlab.com/runner/executors/docker_machine.html>Docker Machine</a>.</li></ul><p>In this example, you use Buildah to:</p><ol><li>Build a Docker image.</li><li>Push it to <a href=/user/packages/container_registry/>GitLab container registry</a>.</li></ol><p>In the last step, Buildah uses the <code>Dockerfile</code> under the
root directory of the project to build the Docker image. Finally, it pushes the image to the
project&rsquo;s container registry:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/buildah/stable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Use vfs with buildah. Docker offers overlayfs as a default, but Buildah</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># cannot stack overlayfs on top of another overlayfs filesystem.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>STORAGE_DRIVER</span><span class=p>:</span><span class=w> </span><span class=l>vfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Write all image metadata in the docker format, not the standard OCI format.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Newer versions of docker can handle the OCI format, but older versions, like</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># the one shipped with Fedora 30, cannot handle the format.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDAH_FORMAT</span><span class=p>:</span><span class=w> </span><span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>FQ_IMAGE_NAME</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$CI_REGISTRY_IMAGE/test&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># GitLab container registry credentials taken from the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># [predefined CI/CD variables](../variables/_index.md#predefined-cicd-variables)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># to authenticate to the registry.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;$CI_REGISTRY_PASSWORD&#34; | buildah login -u &#34;$CI_REGISTRY_USER&#34; --password-stdin $CI_REGISTRY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>buildah images</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>buildah build -t $FQ_IMAGE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>buildah images</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>buildah push $FQ_IMAGE_NAME</span></span></span></code></pre></div></div><p>If you are using GitLab Runner Operator deployed to an OpenShift cluster, try the
<a href=/ci/docker/buildah_rootless_tutorial/>tutorial for using Buildah to build images in rootless container</a>.</p><h2 id=use-the-gitlab-container-registry>Use the GitLab container registry</h2><p>After you&rsquo;ve built a Docker image, you can push it to the
<a href=/user/packages/container_registry/build_and_push_images/#use-gitlab-cicd>GitLab container registry</a>.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=open-pipedocker_engine-the-system-cannot-find-the-file-specified><code>open //./pipe/docker_engine: The system cannot find the file specified</code></h3><p>The following error might appear when you run a <code>docker</code> command in the PowerShell script to access the mounted Docker pipe:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=powershell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\&gt;</span> <span class=n>docker</span> <span class=n>version</span>
</span></span><span class=line><span class=cl><span class=n>Client</span><span class=err>:</span>
</span></span><span class=line><span class=cl> <span class=n>Version</span><span class=err>:</span>           <span class=mf>25.0</span><span class=p>.</span><span class=py>5</span>
</span></span><span class=line><span class=cl> <span class=n>API</span> <span class=n>version</span><span class=err>:</span>       <span class=mf>1.44</span>
</span></span><span class=line><span class=cl> <span class=n>Go</span> <span class=n>version</span><span class=err>:</span>        <span class=n>go1</span><span class=p>.</span><span class=py>21</span><span class=p>.</span><span class=py>8</span>
</span></span><span class=line><span class=cl> <span class=n>Git</span> <span class=n>commit</span><span class=err>:</span>        <span class=n>5dc9bcc</span>
</span></span><span class=line><span class=cl> <span class=n>Built</span><span class=err>:</span>             <span class=n>Tue</span> <span class=n>Mar</span> <span class=mf>19</span> <span class=mf>15</span><span class=err>:</span><span class=mf>06</span><span class=err>:</span><span class=mf>12</span> <span class=mf>2024</span>
</span></span><span class=line><span class=cl> <span class=n>OS</span><span class=p>/</span><span class=n>Arch</span><span class=err>:</span>           <span class=n>windows</span><span class=p>/</span><span class=n>amd64</span>
</span></span><span class=line><span class=cl> <span class=n>Context</span><span class=err>:</span>           <span class=k>default</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>during</span> <span class=n>connect</span><span class=err>:</span> <span class=n>this</span> <span class=n>error</span> <span class=n>may</span> <span class=n>indicate</span> <span class=n>that</span> <span class=n>the</span> <span class=n>docker</span> <span class=n>daemon</span> <span class=n>is</span> <span class=n>not</span> <span class=n>running</span><span class=err>:</span> <span class=n>Get</span> <span class=s2>&#34;http://%2F%2F.%2Fpipe%2Fdocker_engine/v1.44/version&#34;</span><span class=err>:</span> <span class=n>open</span> <span class=p>//./</span><span class=n>pipe</span><span class=p>/</span><span class=n>docker_engine</span><span class=err>:</span> <span class=n>The</span> <span class=n>system</span> <span class=n>cannot</span> <span class=n>find</span> <span class=n>the</span> <span class=n>file</span> <span class=n>specified</span><span class=p>.</span></span></span></code></pre></div></div><p>The error indicates that the Docker Engine is not running on the Windows EKS Node and the Docker pipe binding could not be used in the Windows-based Executor container.</p><p>To solve the problem, use the workaround described in <a href=/ci/docker/using_docker_build/#use-the-kubernetes-executor-with-docker-pipe-binding>Use the Kubernetes executor with Docker pipe binding</a>.</p></div><div data-vue-app=back-to-top-button></div></div><div class="feedback gl-min-h-8" data-ga-section=feedback data-elastic-exclude><div data-component=docs-feedback></div></div></div><aside class=sidebar-right><div data-ga-section=toc data-vue-app=toc></div></aside></div></main><footer data-ga-section=footer><section data-ga-section=footer><div id=footer class="footer-section container gl-grid gl-grid-cols-2 gl-grid-rows-3 gl-grid-rows-auto gl-gap-8 lg:gl-grid-cols-5 lg:gl-grid-rows-1 lg:gl-justify-items-center gl-px-8 gl-py-8 lg:gl-py-10"><div class="gl-col-span-2 lg:gl-col-span-1 gl-row-start-1"><div class="docs-title gl-flex gl-items-center"><a href=/><img src=/gitlab-logo-footer.svg alt="GitLab Docs logo" class=logo width=176 height=24></a></div><ul class="docs-social gl-list-none gl-flex"><li><a href=https://www.facebook.com/gitlab class=facebook><span class=gl-sr-only>Facebook</span></a></li><li><a href=https://www.linkedin.com/company/gitlab-com class=linkedin><span class=gl-sr-only>LinkedIn</span></a></li><li><a href=https://twitter.com/gitlab class=twitter><span class=gl-sr-only>Twitter</span></a></li><li><a href=https://www.youtube.com/channel/UCnMGQ8QHMAnVIsI3xJrihhg class=youtube><span class=gl-sr-only>YouTube</span></a></li></ul><a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel="license noopener noreferrer" class=gl-mt-0><img src=/by-sa.svg alt="Creative Commons License" width=80 height=15></a></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Company</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/company/>About GitLab</a></li><li><a href=https://about.gitlab.com/pricing/>View pricing</a></li><li><a href=https://about.gitlab.com/free-trial/>Try GitLab for free</a></li></ul></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Feedback</div><ul class="gl-list-none gl-p-0"><li><a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/ci/docker/using_docker_build.md>View page source</a></li><li><a href=https://gitlab.com/-/ide/project/gitlab-org/gitlab/edit/master/-/doc/ci/docker/using_docker_build.md>Edit in web IDE</a></li><li><a href=https://about.gitlab.com/community/contribute/>Contribute to GitLab</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/new?issuable_template=Documentation">Suggest updates</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Help & Community</div><ul class="gl-list-none gl-p-0"><li><a href=https://university.gitlab.com/pages/certifications>Get certified</a></li><li><a href=https://about.gitlab.com/support/>Get support</a></li><li><a href="https://forum.gitlab.com/new-topic?title=topic%20title&amp;body=topic%20body&amp;tags=docs-feedback">Post on the GitLab forum</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Resources</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/terms/>Terms</a></li><li><a href=https://about.gitlab.com/privacy/>Privacy statement</a></li><li><a href=/legal/use_generative_ai/>Use of generative AI</a></li><li><a href=/legal/licensing_policy/>Acceptable use of user licenses</a></li><li><button id=ot-sdk-btn class=ot-sdk-show-settings></button></li></ul></div></div></section></footer><script type=module src=/vite/main.js></script><script async>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NJXWQL")</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJXWQL" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script async>(function(){var e,t=!1;function n(){t===!1&&(t=!0,Munchkin.init("194-VVC-221",{useBeaconAPI:!0}))}e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://munchkin.marketo.net/munchkin.js",e.onreadystatechange=function(){(this.readyState=="complete"||this.readyState=="loaded")&&n()},e.onload=n,document.getElementsByTagName("head")[0].appendChild(e)})()</script><script async src=https://cdn.bizible.com/scripts/bizible.js></script><script async>_linkedin_partner_id="30694",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id),function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",t.parentNode.insertBefore(e,t)}()</script><noscript><img height=1 width=1 style=display:none alt src="https://dc.ads.linkedin.com/collect/?pid=30694&fmt=gif"></noscript></body></html>