<!doctype html><html lang=en-us dir=ltr><head><script src=https://cdn.cookielaw.org/consent/7f944245-c5cd-4eed-a90e-dd955adfdd08/OtAutoBlock.js></script><script src=https://cdn.cookielaw.org/scripttemplates/otSDKStub.js data-domain-script=7f944245-c5cd-4eed-a90e-dd955adfdd08></script><script type=text/javascript>function OptanonWrapper(){}</script><script>const callback=(e)=>{for(const t of e)t.type==="childList"&&t.addedNodes.forEach(e=>{e.nodeName==="IMG"&&document.querySelectorAll('img:not([src^="http"]):not([data-ot-ignore])').forEach(e=>{e.setAttribute("data-ot-ignore","")})})},config={attributes:!0,childList:!0,subtree:!0,attributeFilter:["src"]},observer=new MutationObserver(callback);observer.observe(document.documentElement,config)</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-NJXWQL"),gtag("consent","default",{analytics_storage:"granted",ad_storage:"granted",functionality_storage:"granted",wait_for_update:500}),gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied",functionality_storage:"denied",region:["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE","IS","LI","NO","GB","PE","RU"],wait_for_update:500}),window.geofeed=e=>{dataLayer.push({event:"OneTrustCountryLoad",oneTrustCountryId:e.country.toString()})};const json=document.createElement("script");json.setAttribute("src","https://geolocation.onetrust.com/cookieconsentpub/v1/geo/location/geofeed"),document.head.appendChild(json)</script><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Run your CI/CD jobs in Docker containers | GitLab Docs</title><link rel=icon href=/favicon.ico sizes=any><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifests/manifest.webmanifest><meta name=theme-color content="#FC6D26"><link rel=canonical href=https://docs.gitlab.com/ci/docker/using_docker_images/><meta name=description content="Learn how to run your CI/CD jobs in Docker containers hosted on dedicated CI/CD build servers or your local machine."><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"GitLab Docs","url":"https://docs.gitlab.com/"}</script><link rel=preload href=/gitlab_ui/fonts/GitLabSans.woff2 type=font/woff2 as=font crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabSans-Italic.woff2 crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabMono.woff2 crossorigin><link rel=stylesheet href=/gitlab_ui/ui/index.css><link rel=stylesheet href=/vite/main.css><link rel=stylesheet href=/css/syntax-dark.min.css id=syntax-dark-theme><link rel=stylesheet href=/css/syntax-light.min.css id=syntax-light-theme><script>(function(){const p="gitlab-docs-theme",g="gitlab-docs-layout",e={LIGHT:"light",DARK:"dark",AUTO:"auto"},i={FIXED:"fixed",FLUID:"fluid"},d="light",f="fixed";let r=!1;const t=localStorage?.getItem(p),m=localStorage?.getItem(g),l=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?e.DARK:e.LIGHT;function h(){return t&&(t===e.LIGHT||t===e.DARK)?t:(t===e.AUTO&&(r=!0),l||d)}function u(){return m===i.FLUID?i.FLUID:f}const s=h(),c=u(),n=document.documentElement;n.classList.remove("gl-dark","gl-light"),n.classList.add(s===e.DARK?"gl-dark":"gl-light"),c===i.FLUID&&(n.classList.add("fluid"),n.classList.remove("fixed"));const a=document.getElementById("syntax-dark-theme"),o=document.getElementById("syntax-light-theme");a&&o&&(s===e.DARK?(a.disabled=!1,o.disabled=!0):(a.disabled=!0,o.disabled=!1)),window.__initialTheme=r?e.AUTO:s,window.__initialLayout=c})()</script><meta name=gitlab_docs_base_url content="/"><meta name=gitlab_docs_page_owner data-stage=Verify data-group="Runner Core"><meta class=elastic name=gitlab_docs_version content="18.6"><meta class=elastic name=gitlab_docs_section content="use_gitlab"><meta class=elastic name=gitlab_docs_breadcrumbs content="Use GitLab › Use CI/CD to build your application › Jobs › Docker"><script>window.pageMetadata={trail:[{path:"user/",title:"Use GitLab"},{path:"topics/build_your_application/",title:"Use CI/CD to build your application"},{path:"ci/jobs/",title:"Jobs"},{path:"ci/docker/",title:"Docker"},{path:"ci/docker/using_docker_images/",title:"Run CI/CD jobs in Docker containers"}]}</script><meta name=gitlab_docs_legacy_path content="/ee/ci/docker/using_docker_images.html"><meta name=gitlab_docs_hugo_launch_version content="17.9"><script>const ELASTIC_CLOUD_ID="gitlab-docs-website:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDQwZTQyYTQzMTJiZjQyMzNiMzBiZTg0MTU5YjlkNmE1JGMxODg4Y2U5OTY0YzQzZjc5ZjQ1YTk5NDZmMjI0ODg0",ELASTIC_KEY="cDFpLWJaSUJXVHBqWWI4VGZKN3M6eENBSjl4WDRSRnlCUW94ajRQazhLQQ==",ELASTIC_INDEX="search-gitlab-docs-hugo"</script><script type=module src=/vite/elastic_search.js></script><script type=module src=/vite/history.js></script><script>const FS_IDENTIFIER="AIzaSyCLdi3jHHjkmLji9D8uj_RNPMHcdrYoIW4",RECAPTCHA_PUBLIC_KEY="6Le4R3UrAAAAALsIlK_siq0_UhPD-0rD-ImF1gfO"</script><meta name=google-site-verification content="AcGSBNaKDWnLgcYotlVibGy6STm2Y6_KJSaRxrA90xY"><meta name=google-site-verification content="6eFQOFLxYAer08ROqc3I-SAi44F9NmvH7PrUUBR3oCI"><meta name=google-site-verification content="xAUTWp3CDg-tU1LVVwsM9OrVhLR7L3SmiyKzkOuPNos"><meta name=google-site-verification content="F0zzwaMpiyWFcPQ1Lqu18qN3EnuQsqFXbySl_29yvHs"><meta name=google-site-verification content="nwo1bVaU0t9TZxZyM-aOI6-CofaH9GRL-uBPbdREWgc"><meta name=google-site-verification content="rWoHrtHEmIX0t28oOb1ZEDMYZb_EZA6rr6ZOl5otEPI"><meta name=google-site-verification content="fSxr8-uslxcuFL0N-oECp3Tm0RPNEGX97wbdayKOEL8"><meta name=google-site-verification content="ISxyLVnZqU8oY3jwrK7EO9o-2DOTvLJwPse7bZz6yhs"><meta name=google-site-verification content="x1WspIvz3ZHqS0gezfX_P-qiRDOeP2Oyrd68zrU2ErI"><meta name=google-site-verification content="DfXB2Za52GT3zs_vuLIAL4Mi3M3K4qxXcg7MAs0CUqo"><meta name=google-site-verification content="BCEBC2LC7A1NzO9Com1oBrWK88tV_QXfUL0i9mwXPL0"><meta name=google-site-verification content="a2lNcHMorfS43aoISjZt5_BBPo-H1UaTKMQdBgZO9iY"><meta name=google-site-verification content="0s16pP9MelY6wDHRf-izXb5pwLU01IogP-Uc_e8f3GU"><meta name=google-site-verification content="H474RNof35Xp8fLg02fZbg9Dzxdtfch6vtcjzpmUraU"><meta name=google-site-verification content="E0FlhpgBGeE7d1pQ6amdcIWPMDLDeu15-HLQVoDTguE"><meta name=google-site-verification content="opQd7_rXtPy-pX5CO_XZiztzeQEsXnB3j6Y1_dZAizA"><meta name=google-site-verification content="06Kq4AoXdmBOjOAkbPvnYGtSxnn4Q9QBqEO55PLlw5c"><meta name=google-site-verification content="djBBokRFSWV_VRlSE51V5TZSPzMC6hml5l-Sb22WglE"><meta name=google-site-verification content="UOW6nOsvbyMeIySuamzbws4kNC_WqehamWfoxxtKjZ8"><meta name=google-site-verification content="hXU1Gsdba74DUbvbdUHRl9o0cQeiwXIhAdIllOG6p8E"><meta name=google-site-verification content="YFeHIAPk9lE76ubVMeq4P0sQVnzo2-a4k1oU_bPY8yE"><meta name=google-site-verification content="h8ICI4eDkvXmYaGDuLTLoWuXnLn-KUkChqYB-roMRsw"><meta name=google-site-verification content="9QW7feFNlCpMLPm7vAWEU-v14vdzb0Bb3RAk-8e_a18"><meta name=google-site-verification content="26kXLBOjaYRb2UwzWTDl1I1nzA2NxMunhp7SUtxGV6E"><meta name=google-site-verification content="jr3C8t6vKGPyN9GV3esdHY_xGYyQaUNznIl-Un2RObA"><meta name=google-site-verification content="WdlBpRU0ec1ieKqrTY_772OhG23FY45VQ4Lv9DyLJ_Y"><meta name=google-site-verification content="n9i6B9q4Xjr_etK2nQGZH1msoo7vIv9SXV8SQLOUA7c"><meta name=zd-site-verification content="ony3w7hk1vs6tfyrc51mld"><meta name=zd-site-verification content="gtuq65qdzt6n31viazi6hj"></head><body data-elastic-exclude><nav data-ga-section=header data-elastic-exclude><div class="header-wrapper gl-w-full gl-fixed gl-z-4"><div class=header><div class="header-top gl-flex gl-items-center"><a href=#skipTarget class="gl-sr-only skip-link">Skip to main content</a>
<a class=navbar-logo href=/><span class=gl-sr-only>Go to GitLab Docs homepage</span></a><div class="mobile-header gl-w-full gl-text-base"><div class=mobile-header-overlay></div><div class="header-right collapse gl-z-4 gl-border-t lg:gl-border-0"><div class="search-wrapper lg:gl-ml-4 lg:gl-grow"><div class="js-elastic-search-form gl-spinner-container"><span role=status aria-label=Loading class="gl-ml-3 gl-align-text-bottom! gl-spinner gl-spinner gl-spinner-sm"></span></div></div><div class="gl-flex gl-flex-col gl-gap-3 gl-mt-5 lg:gl-mt-0 lg:gl-flex-row lg:gl-items-center gl-ml-auto"><a class="whats-new gl-button btn-default btn-default-tertiary gl-hidden lg:gl-block" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a><div data-vue-app=versions-menu></div><div data-vue-app=appearance-toggle class="gl-hidden lg:gl-block"></div><div class="gl-flex gl-justify-evenly lg:gl-justify-normal gl-items-center gl-gap-5"><a class="whats-new gl-button btn-default btn-default-tertiary gl-w-full lg:gl-hidden hover:gl-no-underline" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a>
<a class="free-trial-btn cta-button gl-button btn-confirm gl-w-full hover:gl-no-underline" href="https://gitlab.com/-/trial_registrations/new?glm_source=docs.gitlab.com&amp;amp;glm_content=navigation-cta-docs" target=_blank rel="noopener noreferrer" role=button>Get free trial</a></div></div></div></div><button class="navbar-toggle gl-button btn-default lg:gl-hidden" data-toggle=collapse data-target=.header-right>
<span class=navbar-toggle-icon></span>
<span class=gl-sr-only>Toggle menu</span></button></div><div class="header-bottom gl-border-t lg:gl-border-b"><ul class="subheader-menu gl-hidden lg:gl-flex gl-list-none gl-text-base gl-space-x-5 gl-py-4 gl-pl-0 gl-mb-0"><li><a href=/user/ class=active>Use GitLab</a></li><li><a href=/user/gitlab_duo/>GitLab Duo</a></li><li><a href=/api/>Extend</a></li><li><a href=/install/>Install</a></li><li><a href=/administration/>Administer</a></li><li><a href=/subscriptions/>Subscribe</a></li><li><a href=/development/>Contribute</a></li><li><a href=/solutions/>Solutions</a></li></ul></div></div></div></nav><main data-ga-section=content-body><div id=js-version-banner></div><div class="template-single gl-flex gl-h-full"><div class=side-nav data-ga-section=side-nav data-vue-app=sidebar-menu></div><div data-pagefind-body class=main-content><div class=docs-content><div class="gl-flex gl-h-5 gl-items-center gl-my-6"><div data-vue-app=open-sidebar></div><div data-vue-app=breadcrumb-nav></div></div><hr class="gl-border-t gl-px-5 lg:gl-hidden"><div class="gl-pt-4 gl-mt-4 lg:gl-pt-0 lg:gl-mt-0 lg:gl-border-t-0"><h1 id=skipTarget class=gl-mb-6>Run your CI/CD jobs in Docker containers</h1></div><div data-elastic-include><div class="availability gl-pl-4 gl-mb-5"><ul class="gl-list-none gl-p-0 gl-m-0"><li><span class=gl-font-bold>Tier</span>: Free, Premium, Ultimate</li><li><span class=gl-font-bold>Offering</span>: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li></ul></div><p>You can run your CI/CD jobs in Docker containers hosted on dedicated CI/CD build servers or your local machine.</p><p>To run CI/CD jobs in a Docker container, you need to:</p><ol><li>Register a runner and configure it to use the <a href=https://docs.gitlab.com/runner/executors/docker.html>Docker executor</a>.</li><li>Specify the container image where you want to run the CI/CD jobs in the <code>.gitlab-ci.yml</code> file.</li><li>Optional. Run other services, like MySQL, in containers. Do this by specifying <a href=/ci/services/>services</a>
in your <code>.gitlab-ci.yml</code> file.</li></ol><h2 id=register-a-runner-that-uses-the-docker-executor>Register a runner that uses the Docker executor</h2><p>To use GitLab Runner with Docker you need to <a href=https://docs.gitlab.com/runner/register/>register a runner</a>
that uses the Docker executor.</p><p>This example shows how to set up a temporary template to supply services:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat &gt; /tmp/test-config.template.toml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>[[runners]]
</span></span></span><span class=line><span class=cl><span class=s>[runners.docker]
</span></span></span><span class=line><span class=cl><span class=s>[[runners.docker.services]]
</span></span></span><span class=line><span class=cl><span class=s>name = &#34;postgres:latest&#34;
</span></span></span><span class=line><span class=cl><span class=s>[[runners.docker.services]]
</span></span></span><span class=line><span class=cl><span class=s>name = &#34;mysql:latest&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div></div><p>Then use this template to register the runner:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo gitlab-runner register <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --url <span class=s2>&#34;https://gitlab.example.com/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token <span class=s2>&#34;</span><span class=nv>$RUNNER_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --description <span class=s2>&#34;docker-ruby:2.6&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --executor <span class=s2>&#34;docker&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --template-config /tmp/test-config.template.toml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-image ruby:3.3</span></span></code></pre></div></div><p>The registered runner uses the <code>ruby:2.6</code> Docker image and runs two
services, <code>postgres:latest</code> and <code>mysql:latest</code>, both of which are
accessible during the build process.</p><h2 id=what-is-an-image>What is an image</h2><p>The <code>image</code> keyword is the name of the Docker image the Docker executor
uses to run CI/CD jobs.</p><p>By default, the executor pulls images from <a href=https://hub.docker.com/>Docker Hub</a>.
However, you can configure the registry location in the <code>gitlab-runner/config.toml</code> file.
For example, you can set the <a href=https://docs.gitlab.com/runner/executors/docker.html#how-pull-policies-work>Docker pull policy</a>
to use local images.</p><p>For more information about images and Docker Hub, see
the <a href=https://docs.docker.com/get-started/overview/>Docker overview</a>.</p><h2 id=image-requirements>Image requirements</h2><p>Any image used to run a CI/CD job must have the following applications installed:</p><ul><li><code>sh</code> or <code>bash</code></li><li><code>grep</code></li></ul><h2 id=define-image-in-the-gitlab-ciyml-file>Define <code>image</code> in the <code>.gitlab-ci.yml</code> file</h2><p>You can define an image that&rsquo;s used for all jobs, and a list of
services that you want to use during runtime:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ruby:2.6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>postgres:16.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>bundle install</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>test</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>bundle exec rake spec</span></span></span></code></pre></div></div><p>The image name must be in one of the following formats:</p><ul><li><code>image: &lt;image-name></code> (Same as using <code>&lt;image-name></code> with the <code>latest</code> tag)</li><li><code>image: &lt;image-name>:&lt;tag></code></li><li><code>image: &lt;image-name>@&lt;digest></code></li></ul><h2 id=extended-docker-configuration-options>Extended Docker configuration options</h2><div class="collapsible-section gl-my-5"><button class="gl-align-middle gl-text-left gl-border-0 gl-pl-0" type=button aria-expanded=false aria-controls=collapsible-1 aria-label="Toggle section" data-toggle=collapse data-target=#collapsible-1>History<span class="gl-ml-2 icon"></span></button><div id=collapsible-1 class="collapsible-list collapse" aria-hidden=true><ul><li>Introduced in GitLab and GitLab Runner 9.4.</li></ul></div></div><p>You can use a string or a map for the <code>image</code> or <code>services</code> entries:</p><ul><li>Strings must include the full image name
(including the registry, if you want to download the image from a registry
other than Docker Hub).</li><li>Maps must contain at least the <code>name</code> option,
which is the same image name as used for the string setting.</li></ul><p>For example, the following two definitions are equal:</p><ul><li><p>A string for <code>image</code> and <code>services</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;registry.example.com/my/image:latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>postgresql:16.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>redis:latest</span></span></span></code></pre></div></div></li><li><p>A map for <code>image</code> and <code>services</code>. The <code>image:name</code> is
required:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;registry.example.com/my/image:latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgresql:16.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis:latest</span></span></span></code></pre></div></div></li></ul><h2 id=where-scripts-are-executed>Where scripts are executed</h2><p>When a CI job runs in a Docker container, the <code>before_script</code>, <code>script</code>, and <code>after_script</code> commands run in the <code>/builds/&lt;project-path>/</code> directory. Your image may have a different default <code>WORKDIR</code> defined. To move to your <code>WORKDIR</code>, save the <code>WORKDIR</code> as an environment variable so you can reference it in the container during the job&rsquo;s runtime.</p><h3 id=override-the-entrypoint-of-an-image>Override the entrypoint of an image</h3><div class="collapsible-section gl-my-5"><button class="gl-align-middle gl-text-left gl-border-0 gl-pl-0" type=button aria-expanded=false aria-controls=collapsible-2 aria-label="Toggle section" data-toggle=collapse data-target=#collapsible-2>History<span class="gl-ml-2 icon"></span></button><div id=collapsible-2 class="collapsible-list collapse" aria-hidden=true><ul><li>Introduced in GitLab and GitLab Runner 9.4. Read more about the <a href=/ci/docker/using_docker_images/#extended-docker-configuration-options>extended configuration options</a>.</li></ul></div></div><p>Before explaining the available entrypoint override methods, let&rsquo;s describe
how the runner starts. It uses a Docker image for the containers used in the
CI/CD jobs:</p><ol><li>The runner starts a Docker container using the defined entrypoint. The default
from <code>Dockerfile</code> that may be overridden in the <code>.gitlab-ci.yml</code> file.</li><li>The runner attaches itself to a running container.</li><li>The runner prepares a script (the combination of
<a href=/ci/yaml/#before_script><code>before_script</code></a>,
<a href=/ci/yaml/#script><code>script</code></a>,
and <a href=/ci/yaml/#after_script><code>after_script</code></a>).</li><li>The runner sends the script to the container&rsquo;s shell <code>stdin</code> and receives the
output.</li></ol><p>To override the <a href=https://docs.gitlab.com/runner/executors/docker.html#configure-a-docker-entrypoint>entrypoint</a> of a Docker image,
in the <code>.gitlab-ci.yml</code> file:</p><ul><li>For Docker 17.06 and later, set <code>entrypoint</code> to an empty value.</li><li>For Docker 17.03 and earlier, set <code>entrypoint</code> to
<code>/bin/sh -c</code>, <code>/bin/bash -c</code>, or an equivalent shell available in the image.</li></ul><p>The syntax of <code>image:entrypoint</code> is similar to <a href=https://docs.docker.com/reference/dockerfile/#entrypoint>Dockerfile <code>ENTRYPOINT</code></a>.</p><p>Let&rsquo;s assume you have a <code>super/sql:experimental</code> image with a SQL database
in it. You want to use it as a base image for your job because you
want to execute some tests with this database binary. Let&rsquo;s also assume that
this image is configured with <code>/usr/bin/super-sql run</code> as an entrypoint. When
the container starts without additional options, it runs
the database&rsquo;s process. The runner expects that the image has no
entrypoint or that the entrypoint is prepared to start a shell command.</p><p>With the extended Docker configuration options, instead of:</p><ul><li>Creating your own image based on <code>super/sql:experimental</code>.</li><li>Setting the <code>ENTRYPOINT</code> to a shell.</li><li>Using the new image in your CI job.</li></ul><p>You can now define an <code>entrypoint</code> in the <code>.gitlab-ci.yml</code> file.</p><p><strong>For Docker 17.06 and later</strong>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>super/sql:experimental</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span></span></span></code></pre></div></div><p><strong>For Docker 17.03 and earlier</strong>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>super/sql:experimental</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>]</span></span></span></code></pre></div></div><h2 id=define-image-and-services-in-configtoml>Define image and services in <code>config.toml</code></h2><p>In the <code>config.toml</code> file, you can define:</p><ul><li>In the <a href=https://docs.gitlab.com/runner/configuration/advanced-configuration#the-runnersdocker-section><code>[runners.docker]</code></a> section,
the container image used to run CI/CD jobs</li><li>In the <a href=https://docs.gitlab.com/runner/configuration/advanced-configuration#the-runnersdockerservices-section><code>[[runners.docker.services]]</code></a> section,
the <a href=/ci/services/>services</a> container</li></ul><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;ruby:latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>services</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;mysql:latest&#34;</span><span class=p>,</span> <span class=s2>&#34;postgres:latest&#34;</span><span class=p>]</span></span></span></code></pre></div></div><p>The image and services defined this way are added to all jobs run by
that runner.</p><h2 id=access-an-image-from-a-private-container-registry>Access an image from a private container registry</h2><p>To access private container registries, the GitLab Runner process can use:</p><ul><li><a href=/ci/docker/using_docker_images/#use-statically-defined-credentials>Statically defined credentials</a>. A username and password for a specific registry.</li><li><a href=/ci/docker/using_docker_images/#use-a-credentials-store>Credentials Store</a>. For more information, see <a href=https://docs.docker.com/reference/cli/docker/login/#credential-stores>the relevant Docker documentation</a>.</li><li><a href=/ci/docker/using_docker_images/#use-credential-helpers>Credential Helpers</a>. For more information, see <a href=https://docs.docker.com/reference/cli/docker/login/#credential-helpers>the relevant Docker documentation</a>.</li></ul><p>When you use the <a href=/user/packages/container_registry/>GitLab Container Registry</a> on the same GitLab instance,
GitLab provides default credentials for this registry. With these credentials, the <code>CI_JOB_TOKEN</code> is used for authentication.
To use the job token, the user starting the job must have at least the Developer role for the project where the private image is hosted.
The project hosting the private image must also allow the other project to authenticate with the job token. This access is disabled by default.
For more details, see <a href=/ci/jobs/ci_job_token/#control-job-token-access-to-your-project>CI/CD job token</a>.</p><p>To define which option should be used, the runner process reads the configuration in this order:</p><ul><li>A <code>config.json</code> file in the <code>/root/.docker</code> directory.</li><li>A <code>DOCKER_AUTH_CONFIG</code> <a href=/ci/variables/>CI/CD variable</a>.</li><li>A <code>DOCKER_AUTH_CONFIG</code> environment variable set in the runner&rsquo;s <code>config.toml</code> file.</li><li>A <code>config.json</code> file in the <code>$HOME/.docker</code> directory of the user who runs the process.
If the <code>--user</code> flag is provided to run the child processes as unprivileged user,
the home directory of the main runner process user is used.</li></ul><h3 id=requirements-and-limitations>Requirements and limitations</h3><ul><li><a href=/ci/docker/using_docker_images/#use-a-credentials-store>Credentials Store</a> and <a href=/ci/docker/using_docker_images/#use-credential-helpers>Credential Helpers</a>
require binaries to be added to the GitLab Runner <code>$PATH</code>, and require access to do so. Therefore,
these features are not available on instance runners, or any other runner where the user does not
have access to the environment where the runner is installed.</li></ul><h3 id=use-statically-defined-credentials>Use statically-defined credentials</h3><p>You can access a private registry using two approaches. Both require setting the CI/CD variable
<code>DOCKER_AUTH_CONFIG</code> with appropriate authentication information.</p><ol><li>Per-job: To configure one job to access a private registry, add
<code>DOCKER_AUTH_CONFIG</code> as a <a href=/ci/variables/>CI/CD variable</a>.</li><li>Per-runner: To configure a runner so all its jobs can access a
private registry, add <code>DOCKER_AUTH_CONFIG</code> as an environment variable in the
runner&rsquo;s configuration.</li></ol><p>See the following sections for examples of each.</p><h4 id=determine-your-docker_auth_config-data>Determine your <code>DOCKER_AUTH_CONFIG</code> data</h4><p>As an example, let&rsquo;s assume you want to use the <code>registry.example.com:5000/private/image:latest</code>
image. This image is private and requires you to sign in to a private container
registry.</p><p>Let&rsquo;s also assume that these are the sign-in credentials:</p><table><thead><tr><th style=text-align:left>Key</th><th style=text-align:left>Value</th></tr></thead><tbody><tr><td style=text-align:left>registry</td><td style=text-align:left><code>registry.example.com:5000</code></td></tr><tr><td style=text-align:left>username</td><td style=text-align:left><code>my_username</code></td></tr><tr><td style=text-align:left>password</td><td style=text-align:left><code>my_password</code></td></tr></tbody></table><p>Use one of the following methods to determine the value for <code>DOCKER_AUTH_CONFIG</code>:</p><ul><li><p>Do a <code>docker login</code> on your local machine:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker login registry.example.com:5000 --username my_username --password my_password</span></span></code></pre></div></div><p>Then copy the content of <code>~/.docker/config.json</code>.</p><p>If you don&rsquo;t need access to the registry from your computer, you
can do a <code>docker logout</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker <span class=nb>logout</span> registry.example.com:5000</span></span></code></pre></div></div></li><li><p>In some setups, it&rsquo;s possible the Docker client uses the available system key
store to store the result of <code>docker login</code>. In that case, it&rsquo;s impossible to
read <code>~/.docker/config.json</code>, so you must prepare the required
base64-encoded version of <code>${username}:${password}</code> and create the Docker
configuration JSON manually. Open a terminal and execute the following command:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># The use of printf (as opposed to echo) prevents encoding a newline in the password.</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;my_username:my_password&#34;</span> <span class=p>|</span> openssl base64 -A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Example output to copy</span>
</span></span><span class=line><span class=cl><span class=nv>bXlfdXNlcm5hbWU6bXlfcGFzc3dvcmQ</span><span class=o>=</span></span></span></code></pre></div></div><div class="alert alert-type-note gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>If your username includes special characters like <code>@</code>, you must escape them with a backslash (<code>\</code>) to prevent authentication problems.</p></div></div><p>Create the Docker JSON configuration content as follows:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;auths&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;registry.example.com:5000&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;auth&#34;</span><span class=p>:</span> <span class=s2>&#34;(Base64 content from above)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></li></ul><h4 id=configure-a-job>Configure a job</h4><p>To configure a single job with access for <code>registry.example.com:5000</code>,
follow these steps:</p><ol><li><p>Create a <a href=/ci/variables/>CI/CD variable</a> <code>DOCKER_AUTH_CONFIG</code> with the content of the
Docker configuration file as the value:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;auths&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;registry.example.com:5000&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;auth&#34;</span><span class=p>:</span> <span class=s2>&#34;bXlfdXNlcm5hbWU6bXlfcGFzc3dvcmQ=&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></li><li><p>You can now use any private image from <code>registry.example.com:5000</code> defined in
<code>image</code> or <code>services</code> in your <code>.gitlab-ci.yml</code> file:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.example.com:5000/namespace/image:tag</span></span></span></code></pre></div></div><p>In the previous example, GitLab Runner looks at <code>registry.example.com:5000</code> for the
image <code>namespace/image:tag</code>.</p></li></ol><p>You can add configuration for as many registries as you want, adding more
registries to the <code>"auths"</code> hash as described previously.</p><p>The full <code>hostname:port</code> combination is required everywhere
for the runner to match the <code>DOCKER_AUTH_CONFIG</code>. For example, if
<code>registry.example.com:5000/namespace/image:tag</code> is specified in the <code>.gitlab-ci.yml</code> file,
then the <code>DOCKER_AUTH_CONFIG</code> must also specify <code>registry.example.com:5000</code>.
Specifying only <code>registry.example.com</code> does not work.</p><h3 id=configuring-a-runner>Configuring a runner</h3><p>If you have many pipelines that access the same registry, you should
set up registry access at the runner level. This
allows pipeline authors to have access to a private registry just by
running a job on the appropriate runner. It also helps simplify registry
changes and credential rotations.</p><p>This means that any job on that runner can access the
registry with the same privilege, even across projects. If you need to
control access to the registry, you need to be sure to control
access to the runner.</p><p>To add <code>DOCKER_AUTH_CONFIG</code> to a runner:</p><ol><li><p>Modify the runner&rsquo;s <code>config.toml</code> file as follows:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>environment</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;DOCKER_AUTH_CONFIG={\&#34;auths\&#34;:{\&#34;registry.example.com:5000\&#34;:{\&#34;auth\&#34;:\&#34;bXlfdXNlcm5hbWU6bXlfcGFzc3dvcmQ=\&#34;}}}&#34;</span><span class=p>]</span></span></span></code></pre></div></div><ul><li>The double quotes included in the <code>DOCKER_AUTH_CONFIG</code>
data must be escaped with backslashes. This prevents them from being
interpreted as TOML.</li><li>The <code>environment</code> option is a list. Your runner may
have existing entries and you should add this to the list, not replace
it.</li></ul></li><li><p>Restart the runner service.</p></li></ol><h3 id=use-a-credentials-store>Use a Credentials Store</h3><p>To configure a Credentials Store:</p><ol><li><p>To use a Credentials Store, you need an external helper program to interact with a specific keychain or external store.
Make sure the helper program is available in the GitLab Runner <code>$PATH</code>.</p></li><li><p>Make GitLab Runner use it. You can accomplish this by using one of the following options:</p><ul><li><p>Create a
<a href=/ci/variables/>CI/CD variable</a>
<code>DOCKER_AUTH_CONFIG</code> with the content of the
Docker configuration file as the value:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;credsStore&#34;</span><span class=p>:</span> <span class=s2>&#34;osxkeychain&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div></div></li><li><p>Or, if you&rsquo;re running self-managed runners, add the JSON to
<code>${GITLAB_RUNNER_HOME}/.docker/config.json</code>. GitLab Runner reads this configuration file
and uses the needed helper for this specific repository.</p></li></ul></li></ol><p><code>credsStore</code> is used to access <strong>all</strong> the registries.
If you use both images from a private registry and public images from Docker Hub,
pulling from Docker Hub fails. Docker daemon tries to use the same credentials for <strong>all</strong> the registries.</p><h3 id=use-credential-helpers>Use Credential Helpers</h3><p>As an example, let&rsquo;s assume that you want to use the <code>&lt;aws_account_id>.dkr.ecr.&lt;region>.amazonaws.com/private/image:latest</code>
image. This image is private and requires you to sign in to a private container registry.</p><p>To configure access for <code>&lt;aws_account_id>.dkr.ecr.&lt;region>.amazonaws.com</code>, follow these steps:</p><ol><li><p>Make sure <a href=https://github.com/awslabs/amazon-ecr-credential-helper><code>docker-credential-ecr-login</code></a> is available in the GitLab Runner <code>$PATH</code>.</p></li><li><p>Have any of the following <a href=https://github.com/awslabs/amazon-ecr-credential-helper#aws-credentials>AWS credentials setup</a>.
Make sure that GitLab Runner can access the credentials.</p></li><li><p>Make GitLab Runner use it. You can accomplish this by using one of the following options:</p><ul><li><p>Create a <a href=/ci/variables/>CI/CD variable</a>
<code>DOCKER_AUTH_CONFIG</code> with the content of the
Docker configuration file as the value:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;credHelpers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;&lt;aws_account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com&#34;</span><span class=p>:</span> <span class=s2>&#34;ecr-login&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>This configures Docker to use the Credential Helper for a specific registry.</p><p>Instead, you can configure Docker to use the Credential Helper for all Amazon Elastic Container Registry (ECR) registries:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=json class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;credsStore&#34;</span><span class=p>:</span> <span class=s2>&#34;ecr-login&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="alert alert-type-note gl-rounded-lg"><div class=alert-icon></div><div class=gl-min-w-0><p>If you use <code>{"credsStore": "ecr-login"}</code>, set the region explicitly in the AWS shared configuration file (<code>~/.aws/config</code>). The region must be specified when the ECR Credential Helper retrieves the authorization token.</p></div></div></li><li><p>Or, if you&rsquo;re running self-managed runners,
add the previous JSON to <code>${GITLAB_RUNNER_HOME}/.docker/config.json</code>.
GitLab Runner reads this configuration file and uses the needed helper for this
specific repository.</p></li></ul></li><li><p>You can now use any private image from <code>&lt;aws_account_id>.dkr.ecr.&lt;region>.amazonaws.com</code> defined in
<code>image</code> and/or <code>services</code> in your <code>.gitlab-ci.yml</code> file:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>&lt;aws_account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/private/image:latest</span></span></span></code></pre></div></div><p>In the example, GitLab Runner looks at <code>&lt;aws_account_id>.dkr.ecr.&lt;region>.amazonaws.com</code> for the
image <code>private/image:latest</code>.</p></li></ol><p>You can add configuration for as many registries as you want, adding more
registries to the <code>"credHelpers"</code> hash.</p><h3 id=use-checksum-to-keep-your-image-secure>Use checksum to keep your image secure</h3><p>Use the image checksum in your job definition in your <code>.gitlab-ci.yml</code> file to verify the integrity of the image. A failed image integrity verification prevents you from using a modified container.</p><p>To use the image checksum you have to append the checksum at the end:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ruby:2.6.8@sha256:d1dbaf9665fe8b2175198e49438092fdbcf4d8934200942b94425301b17853c7</span></span></span></code></pre></div></div><p>To get the image checksum, on the image <code>TAG</code> tab, view the <code>DIGEST</code> column.
For example, view the <a href="https://hub.docker.com/_/ruby?tab=tags">Ruby image</a>.
The checksum is a random string, like <code>6155f0235e95</code>.</p><p>You can also get the checksum of any image on your system with the command <code>docker images --digests</code>:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=shell class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ docker images --digests
</span></span><span class=line><span class=cl>REPOSITORY                                                        TAG       DIGEST                                                                    <span class=o>(</span>...<span class=o>)</span>
</span></span><span class=line><span class=cl>gitlab/gitlab-ee                                                  latest    sha256:723aa6edd8f122d50cae490b1743a616d54d4a910db892314d68470cc39dfb24   <span class=o>(</span>...<span class=o>)</span>
</span></span><span class=line><span class=cl>gitlab/gitlab-runner                                              latest    sha256:4a18a80f5be5df44cb7575f6b89d1fdda343297c6fd666c015c0e778b276e726   <span class=o>(</span>...<span class=o>)</span></span></span></code></pre></div></div><h2 id=creating-a-custom-gitlab-runner-docker-image>Creating a Custom GitLab Runner Docker Image</h2><p>You can create a custom GitLab Runner Docker image to package AWS CLI and Amazon ECR Credential Helper. This setup facilitates
secure and streamlined interactions with AWS services, especially for containerized applications. For example, use this setup
to manage, deploy, and update Docker images on Amazon ECR. This setup helps avoid time consuming, error-prone configurations,
and manual credential management.</p><ol><li><p><a href=/ci/cloud_deployment/#authenticate-gitlab-with-aws>Authenticate GitLab with AWS</a>.</p></li><li><p>Create a <code>Dockerfile</code> with the following content:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=Dockerfile class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=c># Control package versions</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>GITLAB_RUNNER_VERSION</span><span class=o>=</span>v17.3.0<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>AWS_CLI_VERSION</span><span class=o>=</span><span class=m>2</span>.17.36<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># AWS CLI and Amazon ECR Credential Helper</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>amazonlinux</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=s>aws-tools</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>set</span> -e <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> yum update -y <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> yum install -y --allowerasing git make gcc curl unzip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> curl <span class=s2>&#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&#34;</span> --output <span class=s2>&#34;awscliv2.zip&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> unzip awscliv2.zip <span class=o>&amp;&amp;</span> ./aws/install -i /usr/local/bin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> yum clean all<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Download and install ECR Credential Helper</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl --location --output  /usr/local/bin/docker-credential-ecr-login <span class=s2>&#34;https://github.com/awslabs/amazon-ecr-credential-helper/releases/latest/download/docker-credential-ecr-login-linux-amd64&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod +x /usr/local/bin/docker-credential-ecr-login<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Configure the ECR Credential Helper</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p /root/.docker<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s1>&#39;{ &#34;credsStore&#34;: &#34;ecr-login&#34; }&#39;</span> &gt; /root/.docker/config.json<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Final image based on GitLab Runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>gitlab/gitlab-runner:${GITLAB_RUNNER_VERSION</span><span class=o>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Install necessary packages</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> apt-get install -y --no-install-recommends jq procps curl unzip groff libgcrypt20 tar gzip less openssh-client <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> apt-get clean <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy AWS CLI and Amazon ECR Credential Helper binaries</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>aws-tools /usr/local/bin/ /usr/local/bin/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy ECR Credential Helper Configuration</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>aws-tools /root/.docker/config.json /root/.docker/config.json</span></span></code></pre></div></div></li><li><p>To build the custom GitLab Runner Docker image in a <code>.gitlab-ci.yml</code>, include the following example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_DRIVER</span><span class=p>:</span><span class=w> </span><span class=l>overlay2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>IMAGE_NAME</span><span class=p>:</span><span class=w> </span><span class=l>$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>GITLAB_RUNNER_VERSION</span><span class=p>:</span><span class=w> </span><span class=l>v17.3.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>AWS_CLI_VERSION</span><span class=p>:</span><span class=w> </span><span class=m>2.17.36</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>stages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build-image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;Logging into GitLab container registry...&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;Building Docker image...&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker build --build-arg GITLAB_RUNNER_VERSION=${GITLAB_RUNNER_VERSION} --build-arg AWS_CLI_VERSION=${AWS_CLI_VERSION} -t ${IMAGE_NAME} .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;Pushing Docker image to GitLab container registry...&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker push ${IMAGE_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>changes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Dockerfile</span></span></span></code></pre></div></div></li><li><p><a href=https://docs.gitlab.com/runner/register/#docker>Register the runner</a>.</p></li></ol></div><div data-vue-app=back-to-top-button></div></div><div class="feedback gl-min-h-8" data-ga-section=feedback data-elastic-exclude><div data-component=docs-feedback></div></div></div><aside class=sidebar-right><div data-ga-section=toc data-vue-app=toc></div></aside></div></main><footer data-ga-section=footer><section data-ga-section=footer><div id=footer class="footer-section container gl-grid gl-grid-cols-2 gl-grid-rows-3 gl-grid-rows-auto gl-gap-8 lg:gl-grid-cols-5 lg:gl-grid-rows-1 lg:gl-justify-items-center gl-px-8 gl-py-8 lg:gl-py-10"><div class="gl-col-span-2 lg:gl-col-span-1 gl-row-start-1"><div class="docs-title gl-flex gl-items-center"><a href=/><img src=/gitlab-logo-footer.svg alt="GitLab Docs logo" class=logo width=176 height=24></a></div><ul class="docs-social gl-list-none gl-flex"><li><a href=https://www.facebook.com/gitlab class=facebook><span class=gl-sr-only>Facebook</span></a></li><li><a href=https://www.linkedin.com/company/gitlab-com class=linkedin><span class=gl-sr-only>LinkedIn</span></a></li><li><a href=https://twitter.com/gitlab class=twitter><span class=gl-sr-only>Twitter</span></a></li><li><a href=https://www.youtube.com/channel/UCnMGQ8QHMAnVIsI3xJrihhg class=youtube><span class=gl-sr-only>YouTube</span></a></li></ul><a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel="license noopener noreferrer" class=gl-mt-0><img src=/by-sa.svg alt="Creative Commons License" width=80 height=15></a></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Company</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/company/>About GitLab</a></li><li><a href=https://about.gitlab.com/pricing/>View pricing</a></li><li><a href=https://about.gitlab.com/free-trial/>Try GitLab for free</a></li></ul></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Feedback</div><ul class="gl-list-none gl-p-0"><li><a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/ci/docker/using_docker_images.md>View page source</a></li><li><a href=https://gitlab.com/-/ide/project/gitlab-org/gitlab/edit/master/-/doc/ci/docker/using_docker_images.md>Edit in web IDE</a></li><li><a href=https://about.gitlab.com/community/contribute/>Contribute to GitLab</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/new?issuable_template=Documentation">Suggest updates</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Help & Community</div><ul class="gl-list-none gl-p-0"><li><a href=https://university.gitlab.com/pages/certifications>Get certified</a></li><li><a href=https://about.gitlab.com/support/>Get support</a></li><li><a href="https://forum.gitlab.com/new-topic?title=topic%20title&amp;body=topic%20body&amp;tags=docs-feedback">Post on the GitLab forum</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Resources</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/terms/>Terms</a></li><li><a href=https://about.gitlab.com/privacy/>Privacy statement</a></li><li><a href=/legal/use_generative_ai/>Use of generative AI</a></li><li><a href=/legal/licensing_policy/>Acceptable use of user licenses</a></li><li><button id=ot-sdk-btn class=ot-sdk-show-settings></button></li></ul></div></div></section></footer><script type=module src=/vite/main.js></script><script async>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NJXWQL")</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJXWQL" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script async>(function(){var e,t=!1;function n(){t===!1&&(t=!0,Munchkin.init("194-VVC-221",{useBeaconAPI:!0}))}e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://munchkin.marketo.net/munchkin.js",e.onreadystatechange=function(){(this.readyState=="complete"||this.readyState=="loaded")&&n()},e.onload=n,document.getElementsByTagName("head")[0].appendChild(e)})()</script><script async src=https://cdn.bizible.com/scripts/bizible.js></script><script async>_linkedin_partner_id="30694",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id),function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",t.parentNode.insertBefore(e,t)}()</script><noscript><img height=1 width=1 style=display:none alt src="https://dc.ads.linkedin.com/collect/?pid=30694&fmt=gif"></noscript></body></html>