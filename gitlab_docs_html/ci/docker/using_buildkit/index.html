<!doctype html><html lang=en-us dir=ltr><head><script src=https://cdn.cookielaw.org/consent/7f944245-c5cd-4eed-a90e-dd955adfdd08/OtAutoBlock.js></script><script src=https://cdn.cookielaw.org/scripttemplates/otSDKStub.js data-domain-script=7f944245-c5cd-4eed-a90e-dd955adfdd08></script><script type=text/javascript>function OptanonWrapper(){}</script><script>const callback=(e)=>{for(const t of e)t.type==="childList"&&t.addedNodes.forEach(e=>{e.nodeName==="IMG"&&document.querySelectorAll('img:not([src^="http"]):not([data-ot-ignore])').forEach(e=>{e.setAttribute("data-ot-ignore","")})})},config={attributes:!0,childList:!0,subtree:!0,attributeFilter:["src"]},observer=new MutationObserver(callback);observer.observe(document.documentElement,config)</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-NJXWQL"),gtag("consent","default",{analytics_storage:"granted",ad_storage:"granted",functionality_storage:"granted",wait_for_update:500}),gtag("consent","default",{analytics_storage:"denied",ad_storage:"denied",functionality_storage:"denied",region:["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE","IS","LI","NO","GB","PE","RU"],wait_for_update:500}),window.geofeed=e=>{dataLayer.push({event:"OneTrustCountryLoad",oneTrustCountryId:e.country.toString()})};const json=document.createElement("script");json.setAttribute("src","https://geolocation.onetrust.com/cookieconsentpub/v1/geo/location/geofeed"),document.head.appendChild(json)</script><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Build Docker images with BuildKit | GitLab Docs</title><link rel=icon href=/favicon.ico sizes=any><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifests/manifest.webmanifest><meta name=theme-color content="#FC6D26"><link rel=canonical href=https://docs.gitlab.com/ci/docker/using_buildkit/><meta name=description content="GitLab product documentation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"GitLab Docs","url":"https://docs.gitlab.com/"}</script><link rel=preload href=/gitlab_ui/fonts/GitLabSans.woff2 type=font/woff2 as=font crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabSans-Italic.woff2 crossorigin><link rel=prefetch href=/gitlab_ui/fonts/GitLabMono.woff2 crossorigin><link rel=stylesheet href=/gitlab_ui/ui/index.css><link rel=stylesheet href=/vite/main.css><link rel=stylesheet href=/css/syntax-dark.min.css id=syntax-dark-theme><link rel=stylesheet href=/css/syntax-light.min.css id=syntax-light-theme><script>(function(){const p="gitlab-docs-theme",g="gitlab-docs-layout",e={LIGHT:"light",DARK:"dark",AUTO:"auto"},i={FIXED:"fixed",FLUID:"fluid"},d="light",f="fixed";let r=!1;const t=localStorage?.getItem(p),m=localStorage?.getItem(g),l=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?e.DARK:e.LIGHT;function h(){return t&&(t===e.LIGHT||t===e.DARK)?t:(t===e.AUTO&&(r=!0),l||d)}function u(){return m===i.FLUID?i.FLUID:f}const s=h(),c=u(),n=document.documentElement;n.classList.remove("gl-dark","gl-light"),n.classList.add(s===e.DARK?"gl-dark":"gl-light"),c===i.FLUID&&(n.classList.add("fluid"),n.classList.remove("fixed"));const a=document.getElementById("syntax-dark-theme"),o=document.getElementById("syntax-light-theme");a&&o&&(s===e.DARK?(a.disabled=!1,o.disabled=!0):(a.disabled=!0,o.disabled=!1)),window.__initialTheme=r?e.AUTO:s,window.__initialLayout=c})()</script><meta name=gitlab_docs_base_url content="/"><meta name=gitlab_docs_page_owner data-stage=Verify data-group="Pipeline Execution"><meta class=elastic name=gitlab_docs_version content="18.6"><meta class=elastic name=gitlab_docs_section content="use_gitlab"><meta class=elastic name=gitlab_docs_breadcrumbs content="Use GitLab › Use CI/CD to build your application › Jobs › Docker"><script>window.pageMetadata={trail:[{path:"user/",title:"Use GitLab"},{path:"topics/build_your_application/",title:"Use CI/CD to build your application"},{path:"ci/jobs/",title:"Jobs"},{path:"ci/docker/",title:"Docker"},{path:"ci/docker/using_buildkit/",title:"Use BuildKit to build Docker images"}]}</script><meta name=gitlab_docs_legacy_path content="/ee/ci/docker/using_buildkit.html"><meta name=gitlab_docs_hugo_launch_version content="17.9"><script>const ELASTIC_CLOUD_ID="gitlab-docs-website:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDQwZTQyYTQzMTJiZjQyMzNiMzBiZTg0MTU5YjlkNmE1JGMxODg4Y2U5OTY0YzQzZjc5ZjQ1YTk5NDZmMjI0ODg0",ELASTIC_KEY="cDFpLWJaSUJXVHBqWWI4VGZKN3M6eENBSjl4WDRSRnlCUW94ajRQazhLQQ==",ELASTIC_INDEX="search-gitlab-docs-hugo"</script><script type=module src=/vite/elastic_search.js></script><script type=module src=/vite/history.js></script><script>const FS_IDENTIFIER="AIzaSyCLdi3jHHjkmLji9D8uj_RNPMHcdrYoIW4",RECAPTCHA_PUBLIC_KEY="6Le4R3UrAAAAALsIlK_siq0_UhPD-0rD-ImF1gfO"</script><meta name=google-site-verification content="AcGSBNaKDWnLgcYotlVibGy6STm2Y6_KJSaRxrA90xY"><meta name=google-site-verification content="6eFQOFLxYAer08ROqc3I-SAi44F9NmvH7PrUUBR3oCI"><meta name=google-site-verification content="xAUTWp3CDg-tU1LVVwsM9OrVhLR7L3SmiyKzkOuPNos"><meta name=google-site-verification content="F0zzwaMpiyWFcPQ1Lqu18qN3EnuQsqFXbySl_29yvHs"><meta name=google-site-verification content="nwo1bVaU0t9TZxZyM-aOI6-CofaH9GRL-uBPbdREWgc"><meta name=google-site-verification content="rWoHrtHEmIX0t28oOb1ZEDMYZb_EZA6rr6ZOl5otEPI"><meta name=google-site-verification content="fSxr8-uslxcuFL0N-oECp3Tm0RPNEGX97wbdayKOEL8"><meta name=google-site-verification content="ISxyLVnZqU8oY3jwrK7EO9o-2DOTvLJwPse7bZz6yhs"><meta name=google-site-verification content="x1WspIvz3ZHqS0gezfX_P-qiRDOeP2Oyrd68zrU2ErI"><meta name=google-site-verification content="DfXB2Za52GT3zs_vuLIAL4Mi3M3K4qxXcg7MAs0CUqo"><meta name=google-site-verification content="BCEBC2LC7A1NzO9Com1oBrWK88tV_QXfUL0i9mwXPL0"><meta name=google-site-verification content="a2lNcHMorfS43aoISjZt5_BBPo-H1UaTKMQdBgZO9iY"><meta name=google-site-verification content="0s16pP9MelY6wDHRf-izXb5pwLU01IogP-Uc_e8f3GU"><meta name=google-site-verification content="H474RNof35Xp8fLg02fZbg9Dzxdtfch6vtcjzpmUraU"><meta name=google-site-verification content="E0FlhpgBGeE7d1pQ6amdcIWPMDLDeu15-HLQVoDTguE"><meta name=google-site-verification content="opQd7_rXtPy-pX5CO_XZiztzeQEsXnB3j6Y1_dZAizA"><meta name=google-site-verification content="06Kq4AoXdmBOjOAkbPvnYGtSxnn4Q9QBqEO55PLlw5c"><meta name=google-site-verification content="djBBokRFSWV_VRlSE51V5TZSPzMC6hml5l-Sb22WglE"><meta name=google-site-verification content="UOW6nOsvbyMeIySuamzbws4kNC_WqehamWfoxxtKjZ8"><meta name=google-site-verification content="hXU1Gsdba74DUbvbdUHRl9o0cQeiwXIhAdIllOG6p8E"><meta name=google-site-verification content="YFeHIAPk9lE76ubVMeq4P0sQVnzo2-a4k1oU_bPY8yE"><meta name=google-site-verification content="h8ICI4eDkvXmYaGDuLTLoWuXnLn-KUkChqYB-roMRsw"><meta name=google-site-verification content="9QW7feFNlCpMLPm7vAWEU-v14vdzb0Bb3RAk-8e_a18"><meta name=google-site-verification content="26kXLBOjaYRb2UwzWTDl1I1nzA2NxMunhp7SUtxGV6E"><meta name=google-site-verification content="jr3C8t6vKGPyN9GV3esdHY_xGYyQaUNznIl-Un2RObA"><meta name=google-site-verification content="WdlBpRU0ec1ieKqrTY_772OhG23FY45VQ4Lv9DyLJ_Y"><meta name=google-site-verification content="n9i6B9q4Xjr_etK2nQGZH1msoo7vIv9SXV8SQLOUA7c"><meta name=zd-site-verification content="ony3w7hk1vs6tfyrc51mld"><meta name=zd-site-verification content="gtuq65qdzt6n31viazi6hj"></head><body data-elastic-exclude><nav data-ga-section=header data-elastic-exclude><div class="header-wrapper gl-w-full gl-fixed gl-z-4"><div class=header><div class="header-top gl-flex gl-items-center"><a href=#skipTarget class="gl-sr-only skip-link">Skip to main content</a>
<a class=navbar-logo href=/><span class=gl-sr-only>Go to GitLab Docs homepage</span></a><div class="mobile-header gl-w-full gl-text-base"><div class=mobile-header-overlay></div><div class="header-right collapse gl-z-4 gl-border-t lg:gl-border-0"><div class="search-wrapper lg:gl-ml-4 lg:gl-grow"><div class="js-elastic-search-form gl-spinner-container"><span role=status aria-label=Loading class="gl-ml-3 gl-align-text-bottom! gl-spinner gl-spinner gl-spinner-sm"></span></div></div><div class="gl-flex gl-flex-col gl-gap-3 gl-mt-5 lg:gl-mt-0 lg:gl-flex-row lg:gl-items-center gl-ml-auto"><a class="whats-new gl-button btn-default btn-default-tertiary gl-hidden lg:gl-block" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a><div data-vue-app=versions-menu></div><div data-vue-app=appearance-toggle class="gl-hidden lg:gl-block"></div><div class="gl-flex gl-justify-evenly lg:gl-justify-normal gl-items-center gl-gap-5"><a class="whats-new gl-button btn-default btn-default-tertiary gl-w-full lg:gl-hidden hover:gl-no-underline" href=https://about.gitlab.com/releases/categories/releases/ target=_blank rel="noopener noreferrer">What's new?</a>
<a class="free-trial-btn cta-button gl-button btn-confirm gl-w-full hover:gl-no-underline" href="https://gitlab.com/-/trial_registrations/new?glm_source=docs.gitlab.com&amp;amp;glm_content=navigation-cta-docs" target=_blank rel="noopener noreferrer" role=button>Get free trial</a></div></div></div></div><button class="navbar-toggle gl-button btn-default lg:gl-hidden" data-toggle=collapse data-target=.header-right>
<span class=navbar-toggle-icon></span>
<span class=gl-sr-only>Toggle menu</span></button></div><div class="header-bottom gl-border-t lg:gl-border-b"><ul class="subheader-menu gl-hidden lg:gl-flex gl-list-none gl-text-base gl-space-x-5 gl-py-4 gl-pl-0 gl-mb-0"><li><a href=/user/ class=active>Use GitLab</a></li><li><a href=/user/gitlab_duo/>GitLab Duo</a></li><li><a href=/api/>Extend</a></li><li><a href=/install/>Install</a></li><li><a href=/administration/>Administer</a></li><li><a href=/subscriptions/>Subscribe</a></li><li><a href=/development/>Contribute</a></li><li><a href=/solutions/>Solutions</a></li></ul></div></div></div></nav><main data-ga-section=content-body><div id=js-version-banner></div><div class="template-single gl-flex gl-h-full"><div class=side-nav data-ga-section=side-nav data-vue-app=sidebar-menu></div><div data-pagefind-body class=main-content><div class=docs-content><div class="gl-flex gl-h-5 gl-items-center gl-my-6"><div data-vue-app=open-sidebar></div><div data-vue-app=breadcrumb-nav></div></div><hr class="gl-border-t gl-px-5 lg:gl-hidden"><div class="gl-pt-4 gl-mt-4 lg:gl-pt-0 lg:gl-mt-0 lg:gl-border-t-0"><h1 id=skipTarget class=gl-mb-6>Build Docker images with BuildKit</h1></div><div data-elastic-include><div class="availability gl-pl-4 gl-mb-5"><ul class="gl-list-none gl-p-0 gl-m-0"><li><span class=gl-font-bold>Tier</span>: Free, Premium, Ultimate</li><li><span class=gl-font-bold>Offering</span>: GitLab.com, GitLab Self-Managed, GitLab Dedicated</li></ul></div><p><a href=https://docs.docker.com/build/buildkit/>BuildKit</a> is the build engine used by Docker
and provides multi-platform builds and build caching.</p><h2 id=buildkit-methods>BuildKit methods</h2><p>BuildKit offers the following methods to build Docker images:</p><table><thead><tr><th>Method</th><th>Security requirement</th><th>Commands</th><th>Use when you need</th></tr></thead><tbody><tr><td>BuildKit rootless</td><td>No privileged containers</td><td><code>buildctl-daemonless.sh</code></td><td>Maximum security or a replacement for Kaniko</td></tr><tr><td>Docker Buildx</td><td>Requires <code>docker:dind</code></td><td><code>docker buildx</code></td><td>Familiar Docker workflow</td></tr><tr><td>Native BuildKit</td><td>Requires <code>docker:dind</code></td><td><code>buildctl</code></td><td>Advanced BuildKit control</td></tr></tbody></table><h2 id=prerequisites>Prerequisites</h2><ul><li>GitLab Runner with Docker executor</li><li>Docker 19.03 or later to use Docker Buildx</li><li>A project with a <code>Dockerfile</code></li></ul><h2 id=buildkit-rootless>BuildKit rootless</h2><p>BuildKit in standalone mode provides rootless image builds without Docker daemon dependency.
This method eliminates privileged containers entirely and provides a direct replacement for Kaniko builds.</p><p>Key differences from other methods:</p><ul><li>Uses the <code>moby/buildkit:rootless</code> image</li><li>Includes <code>BUILDKITD_FLAGS: --oci-worker-no-process-sandbox</code> for rootless operation</li><li>Uses <code>buildctl-daemonless.sh</code> to manage BuildKit daemon automatically</li><li>No Docker daemon or privileged container dependency</li><li>Requires manual registry authentication setup</li></ul><h3 id=authenticate-with-container-registries>Authenticate with container registries</h3><p>GitLab CI/CD provides automatic authentication for the GitLab container registry through
predefined variables. For BuildKit rootless, you must manually create the Docker
configuration file.</p><h4 id=authenticate-with-the-gitlab-container-registry>Authenticate with the GitLab container registry</h4><p>GitLab automatically provides these predefined variables:</p><ul><li><code>CI_REGISTRY</code>: Registry URL</li><li><code>CI_REGISTRY_USER</code>: Registry username</li><li><code>CI_REGISTRY_PASSWORD</code>: Registry password</li></ul><p>To configure authentication for rootless builds, add a <code>before_script</code> configuration
to your jobs. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span></span></span></code></pre></div></div><h4 id=authenticate-with-multiple-registries>Authenticate with multiple registries</h4><p>To authenticate with additional container registries, combine authentication entries
in your <code>before_script</code> section. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    echo &#34;{
</span></span></span><span class=line><span class=cl><span class=sd>      \&#34;auths\&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>        \&#34;${CI_REGISTRY}\&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>          \&#34;auth\&#34;: \&#34;$(printf &#34;%s:%s&#34; &#34;${CI_REGISTRY_USER}&#34; &#34;${CI_REGISTRY_PASSWORD}&#34; | base64 | tr -d &#39;\n&#39;)\&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        },
</span></span></span><span class=line><span class=cl><span class=sd>        \&#34;docker.io\&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>          \&#34;auth\&#34;: \&#34;$(printf &#34;%s:%s&#34; &#34;${DOCKER_HUB_USER}&#34; &#34;${DOCKER_HUB_PASSWORD}&#34; | base64 | tr -d &#39;\n&#39;)\&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=cl><span class=sd>      }
</span></span></span><span class=line><span class=cl><span class=sd>    }&#34; &gt; ~/.docker/config.json</span></span></span></code></pre></div></div><h4 id=authenticate-with-the-dependency-proxy>Authenticate with the dependency proxy</h4><p>To pull images through the GitLab dependency proxy, configure the authentication
in your <code>before_script</code> section. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    echo &#34;{
</span></span></span><span class=line><span class=cl><span class=sd>      \&#34;auths\&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>        \&#34;${CI_REGISTRY}\&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>          \&#34;auth\&#34;: \&#34;$(printf &#34;%s:%s&#34; &#34;${CI_REGISTRY_USER}&#34; &#34;${CI_REGISTRY_PASSWORD}&#34; | base64 | tr -d &#39;\n&#39;)\&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        },
</span></span></span><span class=line><span class=cl><span class=sd>        \&#34;$(echo -n $CI_DEPENDENCY_PROXY_SERVER | awk -F[:] &#39;{print $1}&#39;)\&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>          \&#34;auth\&#34;: \&#34;$(printf &#34;%s:%s&#34; ${CI_DEPENDENCY_PROXY_USER} &#34;${CI_DEPENDENCY_PROXY_PASSWORD}&#34; | base64 | tr -d &#39;\n&#39;)\&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=cl><span class=sd>      }
</span></span></span><span class=line><span class=cl><span class=sd>    }&#34; &gt; ~/.docker/config.json</span></span></span></code></pre></div></div><p>For more information, see <a href=/user/packages/dependency_proxy/#authenticate-within-cicd>authenticate within CI/CD</a>.</p><h3 id=build-images-in-rootless-mode>Build images in rootless mode</h3><p>To build images without Docker daemon dependency, add a job similar to this example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build-rootless</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><h3 id=build-multi-platform-images-in-rootless-mode>Build multi-platform images in rootless mode</h3><p>To build images for multiple architectures in rootless mode, configure your job
to specify the target platforms. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build-multiarch-rootless</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --opt platform=linux/amd64,linux/arm64 \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><h3 id=use-caching-in-rootless-mode>Use caching in rootless mode</h3><p>To enable registry-based caching for faster subsequent builds, configure cache
import and export in your build job. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build-cached-rootless</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>CACHE_IMAGE</span><span class=p>:</span><span class=w> </span><span class=l>$CI_REGISTRY_IMAGE:cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --export-cache type=registry,ref=$CACHE_IMAGE \
</span></span></span><span class=line><span class=cl><span class=sd>        --import-cache type=registry,ref=$CACHE_IMAGE \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><h3 id=use-a-registry-mirror-in-rootless-mode>Use a registry mirror in rootless mode</h3><p>Registry mirrors provide faster image pulls and can help with rate limiting or network restrictions.</p><p>To configure registry mirrors, create a <code>buildkit.toml</code> file that specifies the mirror endpoints. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build-mirror-rootless</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox --config /tmp/buildkit.toml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cat &lt;&lt;&#39;EOF&#39; &gt; /tmp/buildkit.toml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>[</span><span class=l>registry.&#34;docker.io&#34;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>mirrors = [&#34;mirror.example.com&#34;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>EOF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><p>In this example, replace <code>mirror.example.com</code> with your registry mirror URL.</p><h3 id=configure-proxy-settings>Configure proxy settings</h3><p>If your GitLab Runner operates behind an HTTP(S) proxy, configure proxy settings
as variables in your job. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build-behind-proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http_proxy</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-proxy&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>https_proxy</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-proxy&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>no_proxy</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-no-proxy&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --build-arg http_proxy=$http_proxy \
</span></span></span><span class=line><span class=cl><span class=sd>        --build-arg https_proxy=$https_proxy \
</span></span></span><span class=line><span class=cl><span class=sd>        --build-arg no_proxy=$no_proxy \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><p>In this example, replace <code>&lt;your-proxy></code> and <code>&lt;your-no-proxy></code> with your proxy configuration.</p><h3 id=add-custom-certificates>Add custom certificates</h3><p>To push to a registry using custom CA certificates, add the certificate to the
container&rsquo;s certificate store before building. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build-with-custom-certs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      echo &#34;-----BEGIN CERTIFICATE-----
</span></span></span><span class=line><span class=cl><span class=sd>      ...
</span></span></span><span class=line><span class=cl><span class=sd>      -----END CERTIFICATE-----&#34; &gt;&gt; /etc/ssl/certs/ca-certificates.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><p>In this example, replace the certificate placeholder with your actual certificate content.</p><h2 id=migrate-from-kaniko-to-buildkit>Migrate from Kaniko to BuildKit</h2><p>BuildKit rootless is a secure alternative for Kaniko.
It offers improved performance, better caching, and enhanced security features while
maintaining rootless operation.</p><h3 id=update-your-configuration>Update your configuration</h3><p>Update your existing Kaniko configuration to use the BuildKit rootless method. For example:</p><p>Before, with Kaniko:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/kaniko-project/executor:debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/kaniko/executor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>--<span class=l>context $CI_PROJECT_DIR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>--<span class=l>dockerfile $CI_PROJECT_DIR/Dockerfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>--<span class=l>destination $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span></span></span></code></pre></div></div><p>After, with BuildKit rootless:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:rootless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILDKITD_FLAGS</span><span class=p>:</span><span class=w> </span>--<span class=l>oci-worker-no-process-sandbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl-daemonless.sh build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><h2 id=alternative-buildkit-methods>Alternative BuildKit methods</h2><p>If you don&rsquo;t need rootless builds, BuildKit offers additional methods that require
the <code>docker:dind</code> service but provide familiar workflows or advanced features.</p><h3 id=docker-buildx>Docker Buildx</h3><p>Docker Buildx extends Docker build capabilities with BuildKit features while maintaining
familiar command syntax. This method requires the <code>docker:dind</code> service.</p><h4 id=build-basic-images>Build basic images</h4><p>To build Docker images with Buildx, configure your job with the <code>docker:dind</code> service
and create a <code>buildx</code> builder. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build-image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx create --use --driver docker-container --name builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx inspect --bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx build --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --push .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>after_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx rm builder</span></span></span></code></pre></div></div><h4 id=build-multi-platform-images>Build multi-platform images</h4><p>Multi-platform builds create images for different architectures in a single build command.
The resulting manifest supports multiple architectures,
and Docker automatically selects the appropriate image for each deployment target.</p><p>To build images for multiple architectures, add the <code>--platform</code> flag to specify
target architectures. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build-multiplatform</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx create --use --driver docker-container --name multibuilder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx inspect --bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>platform linux/amd64,linux/arm64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>push .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>after_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx rm multibuilder</span></span></span></code></pre></div></div><h4 id=use-build-caching>Use build caching</h4><p>Registry-based caching stores build layers in a container registry for reuse across builds.</p><p>The <code>mode=max</code> option exports all layers to the cache
and provides maximum reuse potential for subsequent builds.</p><p>To use build caching, add cache options to your build command. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>CACHE_IMAGE</span><span class=p>:</span><span class=w> </span><span class=l>$CI_REGISTRY_IMAGE:cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build-with-cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker:cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx create --use --driver docker-container --name cached-builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx inspect --bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>cache-from type=registry,ref=$CACHE_IMAGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>cache-to type=registry,ref=$CACHE_IMAGE,mode=max</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>--<span class=l>push .</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>after_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker buildx rm cached-builder</span></span></span></code></pre></div></div><h3 id=native-buildkit>Native BuildKit</h3><p>Use native BuildKit <code>buildctl</code> commands for more control over the build process.
This method requires the <code>docker:dind</code> service.</p><p>To use BuildKit directly, configure your job with the BuildKit image and <code>docker:dind</code> service. For example:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=yaml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DOCKER_TLS_CERTDIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build-with-buildkit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>moby/buildkit:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker:dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mkdir -p ~/.docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;{\&#34;auths\&#34;:{\&#34;$CI_REGISTRY\&#34;:{\&#34;username\&#34;:\&#34;$CI_REGISTRY_USER\&#34;,\&#34;password\&#34;:\&#34;$CI_REGISTRY_PASSWORD\&#34;}}}&#34; &gt; ~/.docker/config.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      buildctl build \
</span></span></span><span class=line><span class=cl><span class=sd>        --frontend dockerfile.v0 \
</span></span></span><span class=line><span class=cl><span class=sd>        --local context=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --local dockerfile=. \
</span></span></span><span class=line><span class=cl><span class=sd>        --output type=image,name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA,push=true</span></span></span></code></pre></div></div><h2 id=troubleshooting>Troubleshooting</h2><h3 id=build-fails-with-authentication-errors>Build fails with authentication errors</h3><p>If you encounter registry authentication failures:</p><ul><li>Verify that <code>CI_REGISTRY_USER</code> and <code>CI_REGISTRY_PASSWORD</code> variables are available.</li><li>Check that you have push permissions to the target registry.</li><li>For external registries, ensure authentication credentials are correctly configured
in your project&rsquo;s CI/CD variables.</li></ul><h3 id=rootless-build-fails-with-permission-errors>Rootless build fails with permission errors</h3><p>For permission-related issues in rootless mode:</p><ul><li>Ensure <code>BUILDKITD_FLAGS: --oci-worker-no-process-sandbox</code> is set.</li><li>Verify that the GitLab Runner has sufficient resources allocated.</li><li>Check that no privileged operations are attempted in your <code>Dockerfile</code>.</li></ul><p>If you receive <code>[rootlesskit:child ] error: failed to share mount point: /: permission denied</code>
on a Kubernetes runner, AppArmor is blocking the mount syscall required for BuildKit.</p><p>To resolve this issue, add the following to your runner configuration:</p><div class=codeblock-wrapper><div data-vue-app=codeblock-toolbar data-code-language=toml class=codeblock-toolbar></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>pod_annotations</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;container.apparmor.security.beta.kubernetes.io/build&#34;</span> <span class=p>=</span> <span class=s2>&#34;unconfined&#34;</span></span></span></code></pre></div></div><h3 id=error-invalid-local-stat-pathtoimagedockerfile-not-a-directory>Error: <code>invalid local: stat path/to/image/Dockerfile: not a directory</code></h3><p>You might get an error that states <code>invalid local: stat path/to/image/Dockerfile: not a directory</code>.</p><p>This issue occurs when you specify a file path instead of a directory path for the
<code>--local dockerfile=</code> parameter. BuildKit expects a directory path that contains
a file named <code>Dockerfile</code>.</p><p>To resolve this issue, use the directory path instead of the full file path. For example:</p><ul><li>Use: <code>--local dockerfile=path/to/image</code></li><li>Instead of: <code>--local dockerfile=path/to/image/Dockerfile</code></li></ul><h3 id=multi-platform-builds-fail>Multi-platform builds fail</h3><p>For multi-platform build issues:</p><ul><li>Verify that base images in your <code>Dockerfile</code> support the target architectures.</li><li>Check that architecture-specific dependencies are available for all target platforms.</li><li>Consider using conditional statements in your <code>Dockerfile</code> for architecture-specific logic.</li></ul></div><div data-vue-app=back-to-top-button></div></div><div class="feedback gl-min-h-8" data-ga-section=feedback data-elastic-exclude><div data-component=docs-feedback></div></div></div><aside class=sidebar-right><div data-ga-section=toc data-vue-app=toc></div></aside></div></main><footer data-ga-section=footer><section data-ga-section=footer><div id=footer class="footer-section container gl-grid gl-grid-cols-2 gl-grid-rows-3 gl-grid-rows-auto gl-gap-8 lg:gl-grid-cols-5 lg:gl-grid-rows-1 lg:gl-justify-items-center gl-px-8 gl-py-8 lg:gl-py-10"><div class="gl-col-span-2 lg:gl-col-span-1 gl-row-start-1"><div class="docs-title gl-flex gl-items-center"><a href=/><img src=/gitlab-logo-footer.svg alt="GitLab Docs logo" class=logo width=176 height=24></a></div><ul class="docs-social gl-list-none gl-flex"><li><a href=https://www.facebook.com/gitlab class=facebook><span class=gl-sr-only>Facebook</span></a></li><li><a href=https://www.linkedin.com/company/gitlab-com class=linkedin><span class=gl-sr-only>LinkedIn</span></a></li><li><a href=https://twitter.com/gitlab class=twitter><span class=gl-sr-only>Twitter</span></a></li><li><a href=https://www.youtube.com/channel/UCnMGQ8QHMAnVIsI3xJrihhg class=youtube><span class=gl-sr-only>YouTube</span></a></li></ul><a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel="license noopener noreferrer" class=gl-mt-0><img src=/by-sa.svg alt="Creative Commons License" width=80 height=15></a></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Company</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/company/>About GitLab</a></li><li><a href=https://about.gitlab.com/pricing/>View pricing</a></li><li><a href=https://about.gitlab.com/free-trial/>Try GitLab for free</a></li></ul></div><div class="gl-col-span-1 gl-row-start-2 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Feedback</div><ul class="gl-list-none gl-p-0"><li><a href=https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/ci/docker/using_buildkit.md>View page source</a></li><li><a href=https://gitlab.com/-/ide/project/gitlab-org/gitlab/edit/master/-/doc/ci/docker/using_buildkit.md>Edit in web IDE</a></li><li><a href=https://about.gitlab.com/community/contribute/>Contribute to GitLab</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/new?issuable_template=Documentation">Suggest updates</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Help & Community</div><ul class="gl-list-none gl-p-0"><li><a href=https://university.gitlab.com/pages/certifications>Get certified</a></li><li><a href=https://about.gitlab.com/support/>Get support</a></li><li><a href="https://forum.gitlab.com/new-topic?title=topic%20title&amp;body=topic%20body&amp;tags=docs-feedback">Post on the GitLab forum</a></li></ul></div><div class="gl-col-span-1 gl-row-start-3 lg:gl-row-start-1"><div class="footer-section-title gl-heading-3">Resources</div><ul class="gl-list-none gl-p-0"><li><a href=https://about.gitlab.com/terms/>Terms</a></li><li><a href=https://about.gitlab.com/privacy/>Privacy statement</a></li><li><a href=/legal/use_generative_ai/>Use of generative AI</a></li><li><a href=/legal/licensing_policy/>Acceptable use of user licenses</a></li><li><button id=ot-sdk-btn class=ot-sdk-show-settings></button></li></ul></div></div></section></footer><script type=module src=/vite/main.js></script><script async>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NJXWQL")</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJXWQL" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script async>(function(){var e,t=!1;function n(){t===!1&&(t=!0,Munchkin.init("194-VVC-221",{useBeaconAPI:!0}))}e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://munchkin.marketo.net/munchkin.js",e.onreadystatechange=function(){(this.readyState=="complete"||this.readyState=="loaded")&&n()},e.onload=n,document.getElementsByTagName("head")[0].appendChild(e)})()</script><script async src=https://cdn.bizible.com/scripts/bizible.js></script><script async>_linkedin_partner_id="30694",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id),function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",t.parentNode.insertBefore(e,t)}()</script><noscript><img height=1 width=1 style=display:none alt src="https://dc.ads.linkedin.com/collect/?pid=30694&fmt=gif"></noscript></body></html>